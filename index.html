<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Feedback Guida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .score-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 5px;
        }
        .score-slider:hover {
            opacity: 1;
        }
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        .score-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        /* Stili per il pulsante Blu (Primario) */
        .btn-primary {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 4px #0056b3;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .btn-primary:active {
            background-color: #0056b3;
            box-shadow: 0 2px #0056b3;
            transform: translateY(2px);
        }
        .btn-primary:disabled {
            background-color: #9acaff;
            box-shadow: 0 4px #76a8d5;
            cursor: not-allowed;
        }
        
        /* Stili per il pulsante Rosso (Pericoloso/Blocca) */
        .btn-danger {
            background-color: #dc3545;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 4px #a71d2a;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-danger:active {
            background-color: #a71d2a;
            box-shadow: 0 2px #a71d2a;
            transform: translateY(2px);
        }
         .btn-danger:disabled {
            background-color: #f19ca5;
            box-shadow: 0 4px #d17e87;
            cursor: not-allowed;
        }
        
        /* Stili per il pulsante Grigio (Secondario/Chiudi) */
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 0 4px #4a4e53;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-secondary:active {
            background-color: #4a4e53;
            box-shadow: 0 2px #4a4e53;
            transform: translateY(2px);
        }
        
        /* Stili per la Home Page */
        .saved-lesson-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .saved-lesson-item a {
            font-weight: 500;
            color: #007bff;
            text-decoration: none;
        }
        .saved-lesson-item a:hover {
            text-decoration: underline;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- 
    PAGINA DI AVVIO (LANDING PAGE)
    Visibile solo se non c'è un ID lezione nell'URL
-->
<div id="home-view" class="container">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-6 text-center">
        Calcolatore Feedback Guida
    </h1>
    
    <!-- Card per Nuova Lezione -->
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Crea Nuova Valutazione</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="student-name-input" placeholder="Nome e Cognome Allievo" class="flex-grow w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button id="start-lesson-btn" onclick="startNewLesson()" class="btn-primary">
                Inizia Valutazione
            </button>
        </div>
        <p id="landing-error" class="text-red-600 text-sm mt-2 hidden"></p>
    </div>

    <!-- Card per Lezioni Salvate -->
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Valutazioni Salvate</h2>
        <div id="saved-lessons-list" class="space-y-2">
            <!-- Elenco caricato da JS -->
            <p class="text-gray-500">Nessuna valutazione salvata.</p>
        </div>
    </div>
</div>

<!-- 
    PAGINA CALCOLATORE (APP PRINCIPALE)
    Visibile solo se c'è un ID lezione nell'URL
-->
<div id="calculator-page" class="container hidden">
    <!-- SEZIONE GESTIONE E SALVATAGGIO (NUOVA) -->
    <div id="management-section" class="card">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">
                    Allievo: <span id="student-name-display" class="text-blue-600">...</span>
                </h1>
                <p id="lock-status" class="text-sm font-medium text-gray-500">
                    Stato: <span class="text-yellow-600 font-bold">In corso (Salvataggio automatico)</span>
                </p>
            </div>
            <div class="flex gap-4">
                <button id="lock-lesson-btn" onclick="saveLessonData(true)" class="btn-danger">
                    Blocca e Archivia
                </button>
                <button onclick="goBackToList()" class="btn-secondary">
                    Torna alla Lista
                </button>
            </div>
        </div>
    </div>

    <!-- VALUTAZIONE RAPIDA (1) -->
    <div id="valuation-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Valutazione Rapida (20 Criteri, Scala 0-10)</h2>
        <p class="text-sm text-gray-600 mb-4">
            Assegna un punteggio da 0 a 10. Il salvataggio è automatico ad ogni modifica.
        </p>

        <div id="quick-criteria-container" class="grid lg:grid-cols-3 md:grid-cols-2 gap-x-8 gap-y-6">
            <!-- I criteri rapidi sono inseriti dal JS -->
        </div>

        <div class="mt-8">
            <label for="lesson-notes" class="block text-sm font-medium text-gray-700 mb-2">Note della Lezione (Opzionale):</label>
            <textarea id="lesson-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
    </div>

    <!-- RIEPILOGO AREE DI COMPETENZA (2) -->
    <div id="competency-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">2. Riepilogo Aree di Competenza (Scala 0-50)</h2>
        <div id="competency-summary" class="grid md:grid-cols-2 gap-4">
            <!-- I punteggi delle 10 aree saranno qui -->
        </div>
        <div class="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg flex justify-between items-center">
            <span class="text-lg font-bold text-indigo-800">Punteggio Totale Calcolato (Somma delle 10 Aree):</span>
            <span id="total-score-500" class="text-2xl font-extrabold text-indigo-800">0 / 500</span>
        </div>
    </div>

    <!-- RIEPILOGO DETTAGLIATO CALCOLATO (3) -->
    <div id="detailed-summary-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
            3. Riepilogo Dettagliato Calcolato (77 Criteri, Scala 0-5)
            <span class="text-sm font-normal text-indigo-600">(Aggiornato in tempo reale)</span>
        </h2>
        
        <!-- Contenuto Raggruppato dalle 10 Aree di Competenza -->
        <div id="calculated-scores-container">
            <!-- I punteggi dettagliati raggruppati saranno inseriti qui -->
        </div>
    </div>
    
    <!-- SEZIONE GEMINI RIMOSSA -->

</div>

<!-- LOGICA JAVASCRIPT E GESTIONE LOCALSTORAGE -->
<script type="module">

    let quickScores = {}; 
    let currentLessonId = null;
    let isPageLocked = false;
    
    // 1. Mappatura Descrizioni 0-10
    const SCORE_10_INTERPRETATION = {
        0: "Non ancora spiegato → L'argomento o la manovra non è stata ancora trattata.",
        1: "Grave errore → Tentativo fallito, comportamento inadeguato.",
        2: "Molto insicuro → Errori gravi, necessità di intervento.",
        3: "Insicuro → Errori evidenti, esecuzione incerta.",
        4: "Migliorabile → Errori non gravi, ma guida imprecisa.",
        5: "Quasi sufficiente → Autonomia parziale, migliorabile.",
        6: "Sufficiente → Controllo adeguato, ma con margini di miglioramento.",
        7: "Discreto → Guida sicura con qualche imprecisione.",
        8: "Buono → Buon controllo del veicolo e sicurezza elevata.",
        9: "Distinto → Guida fluida con anticipazione dei rischi.",
        10: "Ottimo → Controllo totale, sicurezza massima."
    };

    // 2. Lista dei 20 criteri rapidi (Scala 0-10)
    const QUICK_CRITERIA = [
        "Sguardo", "Fluidità nel volante", "Accelerazione in partenza", "Modulazione della frenata", 
        "Fluidità nel cambio", "Utilizzo della frizione", "Partenza in salita", "Posizione del veicolo su strada", 
        "Svolta a destra", "Svolta a sinistra", "Comportamento negli incroci", "Punto morto", 
        "Voltarsi nelle retromarce", "Inversione di marcia", "Parcheggi in retromarcia", "Accostare il veicolo", 
        "Padronanza delle situazioni", "Postura di guida", "Regolazione e uso degli specchi retrovisori", 
        "Uso e conoscenza dei dispositivi e teoria motore"
    ];

    // 3. Lista dei 77 criteri dettagliati (Scala 0-5)
    const DETAILED_CRITERIA = [
        "Regolazione sedile in distanza, altezza ed inclinazione", "Regolazione specchi, poggiatesta e cintura", "Posizione corretta delle mani", "Uso volante in curva aperta dx sx", "Uso volante in curva media dx sx", "Uso volante in curva stretta dx sx", "Uso volante in svolta dx sx", "Uso visione centrale e direzione del veicolo", "Uso visione periferica", "Dinamicità dello sguardo", "Capacità di anticipazione visiva", "Corretto utilizzo sguardo in curva a destra", "Corretto utilizzo sguardo in curva a sinistra", "Corretta sequenza rti (retrovisori, testa, indicatore)", "Sensibilità all'uso dell'acceleratore", "Sensibilità uso freno frenata degressiva", "Passaggio freno acceleratore ancoraggio tacco", "Frenata di precisione rispetto ad un punto d'arresto predeterminato", "Frenata in situazioni di pericolo", "Corretto utilizzo del piede sulla frizione", "Piede su passaruota con frizione a riposo", "Ricerca innesto frizione", "Tenuta pedale dopo innesto", "Combinazione gas frizione in partenza", "Partenza in pianura discesa", "Partenza in salita", "Impostazioni mano su cambio", "Incremento marce seconda e terza", "Decremento marce terza e seconda", "Sequenza completa incremento marce", "Sequenza completa scalata marce", "Preparazione cambiata anticipo mano", "Incremento marce con equilibrio volante", "Scalata tenuta freno e uso frizione", "Coordinazione motoria frizione cambio volante", "Svolta a sx su strada a doppio senso (posizione, esecuzione)", "Svolta a sx su strada a senso unico (posizione, esecuzione)", "Svolta a destra (posizione esecuzione)", "Comportamenti alle rotatorie", "Comportamento in preselezione di incrocio", "Rispetto della segnaletica agli incroci", "Capacità di adattamento al buio", "Comportamento nei confronti dei veicoli che provengono dalla direzione opposta, anche in caso di spazio limitato", "Superamento di ostacoli (vetture parcheggiate, ostacoli in genere)", "Comportamento alle fermate di bus/tram", "Rispetto degli attraversamenti pedonali e dei comportamenti correlati ai pedoni", "Guida proattiva - Capacità di prevenire il pericolo", "Capacità di adattamento velocità alla strada ed ai suoi limiti", "Corretto utilizzo del cambio di velocità (eco)", "Comprensione del punto di cambiata", "Utilizzo razionale dell'inerzia (eco roll)", "Utilizzo razionale del freno motore (cut-off)", "Rispetto delle distanze di sicurezza", "Ingresso su corsia di accelerazione", "Inserimento nel traffico in condizioni di sicurezza", "Capacità di valutazione delle distanze ed adattamento al traffico", "Uso corretto degli specchi retrovisori nella fase di inizio del sorpasso", "Corretta gestione del volante nella fase di inizio e fine sorpasso", "Rientro dal sorpasso in sicurezza (specchi, ecc)", "Uscita su strade a precedenza mediante corsia di decelerazione", "Retromarcia in rettilineo", "Retromarcia ad L con svolta a sinistra", "Retromarcia ad L con svolta a destra", "Inversione di marcia con marcia avanti", "Inversione di marcia in retromarcia", "Parcheggi in retromarcia parallelo a destra", "Parcheggi in retromarcia parallelo a sinistra", "Parcheggio in retromarcia su strada in pendenza", "Parcheggio a pettine (in retromarcia ed in avanti)", "Parcheggio a spina (in retromarcia ed in avanti)", "Controllo carta di circolazione", "Controllo pneumatici", "Controllo sterzo e comandi sul volante", "Controllo livelli", "Controllo dispositivi di segnalazione visiva ed illuminazione", "Controllo corretta chiusura porte - cofano motore", "Corrette operazioni nella discesa dal veicolo"
    ];

    // Mappatura delle interpretazioni del punteggio (Scala 0-5)
    const SCORE_5_INTERPRETATION = {
        0: { text: "Non trattato / Grave", color: "bg-red-200 text-red-800" },
        1: { text: "Grave / Intervento", color: "bg-red-200 text-red-800" },
        2: { text: "Migliorabile / Imprecisa", color: "bg-yellow-200 text-yellow-800" },
        3: { text: "Sufficiente / Adeguato", color: "bg-green-200 text-green-800" },
        4: { text: "Buono / Fluida", color: "bg-green-200 text-green-800" },
        5: { text: "Ottimo / Controllo totale", color: "bg-green-200 text-green-800" }
    };

    // Mappatura delle 10 Aree di Competenza ai criteri dettagliati
    const COMPETENCY_AREAS = [
        { name: "1. Postura, Sguardo, Volante", criteria: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13] },
        { name: "2. Acceleratore e Freno", criteria: [14, 15, 16, 17, 18] },
        { name: "3. Frizione e Cambio", criteria: [19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34] },
        { name: "4. Incroci e Svolte", criteria: [35, 36, 37, 38, 39, 40] },
        { name: "5. Guida Notturna Urbana - Mod. A", criteria: [41, 42, 43, 44, 45, 46] },
        { name: "6. Guida Extraurbana ed EcoGuida - Mod. B", criteria: [47, 48, 49, 50, 51, 52] },
        { name: "7. Guida in Autostrada - Mod. C", criteria: [53, 54, 55, 56, 57, 58, 59] },
        { name: "8. Retromarcia ed Inversione", criteria: [60, 61, 62, 63, 64] },
        { name: "9. Parcheggi", criteria: [65, 66, 67, 68, 69] },
        { name: "10. Fase I Esame", criteria: [70, 71, 72, 73, 74, 75, 76] }
    ];

    // --- FUNZIONI DI CALCOLO (INVARIATE) ---

    function customRound(value) {
        if (value <= 0.5) return 0;
        if (value <= 1.5) return 1;
        if (value <= 2.5) return 2;
        if (value <= 3.5) return 3;
        if (value <= 4.5) return 4;
        return 5; 
    }

    function calculateAreaScore(indices, detailedScores) {
        let sum = 0;
        let count = 0;
        indices.forEach(index => {
            const criterionName = DETAILED_CRITERIA[index];
            const score = detailedScores[criterionName];
            if (typeof score === 'number') {
                sum += score;
                count++;
            }
        });
        const average_0_5 = count > 0 ? sum / count : 0;
        const score_0_50 = average_0_5 * 10;
        return Math.min(50, Math.max(0, parseFloat(score_0_50.toFixed(0)))); 
    }
    
    function calculateScores(quickScores) {
        const calculatedScores = {};
        const q = QUICK_CRITERIA.map(name => quickScores[name] || 0);
        const getQ = (index) => q[index] || 0;

        const formulas = [
            (q) => (getQ(17) * 1) / 2, (q) => (getQ(18) * 0.5 + getQ(17) * 0.5) / 2, (q) => (getQ(17) * 1) / 2, 
            (q) => (getQ(2) * 0.5 + getQ(9) * 0.25 + getQ(10) * 0.25) / 2, (q) => (getQ(2) * 0.4 + getQ(9) * 0.3 + getQ(10) * 0.3) / 2, 
            (q) => (getQ(2) * 0.5 + getQ(9) * 0.25 + getQ(10) * 0.25) / 2, (q) => (getQ(2) * 0.6 + getQ(9) * 0.2 + getQ(10) * 0.2) / 2, 
            (q) => (getQ(1) * 1) / 2, (q) => (getQ(1) * 1) / 2, (q) => (getQ(1) * 1) / 2, (q) => (getQ(1) * 1) / 2, 
            (q) => (getQ(1) * 0.5 + getQ(9) * 0.5) / 2, (q) => (getQ(1) * 0.5 + getQ(10) * 0.5) / 2, 
            (q) => (getQ(18) * 0.4 + getQ(11) * 0.1 + getQ(1) * 0.3 + getQ(8) * 0.1 + getQ(16) * 0.1) / 2, 
            (q) => getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(1) * 0.5) / 2 : 0, 
            (q) => getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(1) * 0.5) / 2 : 0, 
            (q) => getQ(3) > 0 ? (getQ(17) * 1) / 2 : 0, 
            (q) => getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(1) * 0.25 + getQ(16) * 0.25) / 2 : 0, 
            (q) => getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(1) * 0.25 + getQ(17) * 0.25) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 0.5 + getQ(17) * 0.5) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 0.5 + getQ(17) * 0.5) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 1) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 0.5 + getQ(17) * 0.5) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 0.5 + getQ(3) * 0.5) / 2 : 0, 
            (q) => getQ(6) > 0 ? (getQ(6) * 0.5 + getQ(3) * 0.5) / 2 : 0, 
            (q) => (getQ(7) * 1) / 2, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.7 + getQ(6) * 0.3) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.7 + getQ(6) * 0.2 + getQ(4) * 0.1) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(6) * 0.25 + getQ(8) * 0.25) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(6) * 0.2 + getQ(4) * 0.2 + getQ(8) * 0.1) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(2) * 0.5) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(4) * 0.25 + getQ(6) * 0.25) / 2 : 0, 
            (q) => getQ(5) > 0 ? (getQ(5) * 0.25 + getQ(4) * 0.25 + getQ(6) * 0.25 + getQ(2) * 0.25) / 2 : 0, 
            (q) => (getQ(9) * 1) / 2, (q) => (getQ(10) * 1) / 2, (q) => (getQ(8) * 1) / 2, 
            (q) => (getQ(11) * 1) / 2, 
            (q) => (getQ(11) * 0.8 + getQ(1) * 0.1 + getQ(17) * 0.1) / 2, 
            (q) => (getQ(11) * 0.8 + getQ(1) * 0.1 + getQ(17) * 0.1) / 2, 
            (q) => (getQ(1) * 0.75 + getQ(17) * 0.25) / 2, 
            (q) => (getQ(11) * 0.5 + getQ(1) * 0.3 + getQ(8) * 0.1 + getQ(19) * 0.1) / 2, 
            (q) => (getQ(11) * 0.5 + getQ(1) * 0.3 + getQ(8) * 0.1 + getQ(19) * 0.1) / 2, 
            (q) => (getQ(11) * 0.5 + getQ(1) * 0.3 + getQ(8) * 0.1 + getQ(19) * 0.1) / 2, 
            (q) => (getQ(11) * 0.5 + getQ(1) * 0.3 + getQ(8) * 0.1 + getQ(19) * 0.1) / 2, 
            (q) => (getQ(1) * 0.5 + getQ(17) * 0.5) / 2, 
            (q) => (getQ(3) * 0.5 + getQ(4) * 0.5) / 2, 
            (q) => (getQ(5) * 0.5 + getQ(8) * 0.5) / 2, 
            (q) => (getQ(5) * 1) / 2, 
            (q) => (getQ(5) * 0.5 + getQ(6) * 0.5) / 2, 
            (q) => (getQ(4) * 0.2 + getQ(5) * 0.8) / 2, 
            (q) => (getQ(1) * 0.5 + getQ(8) * 0.5) / 2, 
            (q) => (getQ(11) * 1) / 2, 
            (q) => (getQ(8) * 0.2 + getQ(2) * 0.2 + getQ(3) * 0.2 + getQ(6) * 0.2 + getQ(12) * 0.2) / 2, 
            (q) => (getQ(1) * 0.5 + getQ(8) * 0.5) / 2, 
            (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, 
            (q) => (getQ(2) * 1) / 2, 
            (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, 
            (q) => (getQ(11) * 1) / 2, 
            (q) => getQ(12) > 0 ? (getQ(12) * 1) / 2 : 0, 
            (q) => getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(9) * 0.2) / 2 : 0, 
            (q) => getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(8) * 0.2) / 2 : 0, 
            (q) => (getQ(13) * 1) / 2, 
            (q) => (getQ(13) * 1) / 2, 
            (q) => (getQ(14) * 1) / 2, 
            (q) => (getQ(14) * 1) / 2, 
            (q) => (getQ(14) * 1) / 2, 
            (q) => (getQ(14) * 1) / 2, 
            (q) => (getQ(14) * 1) / 2, 
            (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, 
            (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2
        ];

        DETAILED_CRITERIA.forEach((criterion, index) => {
            try {
                const decimalResult = formulas[index](q);
                calculatedScores[criterion] = customRound(decimalResult);
            } catch (e) {
                console.error(`Errore nel calcolo del criterio ${criterion} (indice ${index}):`, e);
                calculatedScores[criterion] = 0; 
            }
        });

        const competencyAreas = {};
        let totalScore_0_500 = 0;

        COMPETENCY_AREAS.forEach(area => {
            const areaScore = calculateAreaScore(area.criteria, calculatedScores);
            competencyAreas[area.name] = areaScore;
            totalScore_0_500 += areaScore;
        });

        return { calculatedScores, competencyAreas, totalScore_0_500 };
    }

    // --- FUNZIONI API GEMINI RIMOSSE ---

    // --- NUOVA LOGICA DI PAGINAZIONE E STORAGE ---

    document.addEventListener('DOMContentLoaded', initPage);

    function initPage() {
        // --- MODIFICA ---
        // Rimuoviamo tutta la logica 'hash'. Mostra sempre la home page all'inizio.
        // const hash = window.location.hash.substring(1); // Rimuove #
        // if (hash) {
        //     // Siamo in una pagina di calcolo
        //     currentLessonId = hash;
        //     showCalculatorPage();
        //     loadLesson(currentLessonId);
        // } else {
        //     // Siamo sulla landing page
        //     showLandingPage();
        //     loadSavedLessonsList();
        // }
        showHomeView();
        // --- FINE MODIFICA ---
    }

    function showHomeView() {
        document.getElementById('home-view').classList.remove('hidden');
        document.getElementById('calculator-page').classList.add('hidden');
        document.getElementById('student-name-input').value = ""; // Pulisce l'input
        loadSavedLessonsList(); // Ricarica la lista
    }

    function showCalculatorPage(lessonId) {
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('calculator-page').classList.remove('hidden');
        loadLesson(lessonId); // Carica i dati dell'allievo specifico
    }

    function startNewLesson() {
        const studentNameInput = document.getElementById('student-name-input');
        const errorEl = document.getElementById('landing-error');
        const studentName = studentNameInput.value.trim();

        if (!studentName) {
            errorEl.textContent = "Per favore, inserisci nome e cognome dell'allievo.";
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        const lessonId = 'lesson_' + Date.now();
        
        // Crea i punteggi di default
        const defaultScores = {};
        QUICK_CRITERIA.forEach(name => {
            defaultScores[name] = 5; // Default a 5
        });

        const lessonData = {
            studentName: studentName,
            scores: defaultScores,
            notes: "",
            isLocked: false
        };

        // Salva i dati di default e apre la nuova scheda
        localStorage.setItem(lessonId, JSON.stringify(lessonData));
        
        // --- MODIFICA ---
        // Rimuove l'apertura di una nuova scheda e mostra la vista calcolatore
        // const baseUrl = window.location.href.split('#')[0];
        // window.open(baseUrl + '#' + lessonId, '_blank');
        showCalculatorPage(lessonId);
        // --- FINE MODIFICA ---
        
        // Non è più necessario ricaricare la lista qui
        // loadSavedLessonsList();
        // studentNameInput.value = "";
    }

    function loadSavedLessonsList() {
        const listContainer = document.getElementById('saved-lessons-list');
        listContainer.innerHTML = ''; // Pulisce la lista
        let hasLessons = false;

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('lesson_')) {
                hasLessons = true;
                const data = JSON.parse(localStorage.getItem(key));
                const status = data.isLocked 
                    ? '<span class="text-red-600 font-semibold">Bloccato</span>' 
                    : '<span class="text-green-600 font-semibold">In corso</span>';
                
                const itemEl = document.createElement('div');
                itemEl.className = 'saved-lesson-item';
                itemEl.innerHTML = `
                    <div>
                        <a href="#" class="font-medium text-blue-600 hover:underline" onclick="openLesson('${key}'); return false;">${data.studentName}</a>
                        <span class="text-sm ml-2">(${status})</span>
                    </div>
                    <button class="delete-btn" title="Elimina" onclick="deleteLesson('${key}')">&times;</button>
                `;
                listContainer.appendChild(itemEl);
            }
        }

        if (!hasLessons) {
            listContainer.innerHTML = '<p class="text-gray-500">Nessuna valutazione salvata.</p>';
        }
    }

    function deleteLesson(lessonId) {
        // Usa un semplice prompt per conferma (sostituirebbe il confirm bloccato)
        const check = prompt(`Sei sicuro di voler eliminare questa valutazione? Digita "ELIMINA" per confermare.`);
        if (check === 'ELIMINA') {
            localStorage.removeItem(lessonId);
            loadSavedLessonsList(); // Ricarica la lista dopo l'eliminazione
        }
    }

    // --- NUOVA FUNZIONE ---
    // Apre la vista calcolatore per una lezione esistente
    function openLesson(lessonId) {
        showCalculatorPage(lessonId);
    }
    // --- FINE NUOVA FUNZIONE ---

    function loadLesson(lessonId) {
        // --- MODIFICA ---
        // Imposta l'ID corrente qui, perché initPage non lo fa più
        currentLessonId = lessonId;
        // --- FINE MODIFICA ---
        
        const dataString = localStorage.getItem(lessonId);
        if (!dataString) {
            alert("Errore: Lezione non trovata.");
            window.location.href = window.location.pathname; // Torna alla home
            return;
        }

        const data = JSON.parse(dataString);
        
        quickScores = data.scores;
        isPageLocked = data.isLocked;
        
        document.getElementById('student-name-display').textContent = data.studentName;
        document.getElementById('lesson-notes').value = data.notes;
        
        // Aggiunge il listener per le note per l'auto-salvataggio
        document.getElementById('lesson-notes').addEventListener('input', () => saveLessonData(false));

        // Renderizza i componenti UI con i dati caricati
        renderQuickCriteria(quickScores);
        
        // Calcola e renderizza i punteggi derivati
        const { calculatedScores, competencyAreas, totalScore_0_500 } = calculateScores(quickScores);
        renderDetailedSummary(calculatedScores);
        renderCompetencyAreas(competencyAreas, totalScore_0_500);

        if (isPageLocked) {
            lockPage();
        }
    }

    function saveLessonData(isLocking) {
        if (isPageLocked) return; // Non salvare se la pagina è già bloccata

        if (isLocking) {
             const check = prompt(`Sei sicuro di voler bloccare e archiviare questa valutazione? Non potrai più modificarla. Digita "BLOCCA" per confermare.`);
             if (check !== 'BLOCCA') {
                 return; // Annulla il blocco
             }
             isPageLocked = true;
        }
        
        const currentData = {
            studentName: document.getElementById('student-name-display').textContent,
            scores: quickScores,
            notes: document.getElementById('lesson-notes').value,
            isLocked: isPageLocked
        };

        localStorage.setItem(currentLessonId, JSON.stringify(currentData));

        if (isPageLocked) {
            lockPage();
        } else {
             // Feedback visivo di salvataggio (opzionale)
            const statusEl = document.getElementById('lock-status');
            statusEl.innerHTML = '<span class="text-blue-600 font-bold">Salvato!</span>';
            setTimeout(() => {
                 if(!isPageLocked) {
                    statusEl.innerHTML = '<span class="text-yellow-600 font-bold">In corso (Salvataggio automatico)</span>';
                 }
            }, 1500);
        }
    }

    function lockPage() {
        isPageLocked = true;
        
        // Aggiorna stato
        document.getElementById('lock-status').innerHTML = '<span class="text-red-600 font-bold">Archiviato (Bloccato)</span>';
        
        // Disabilita bottoni
        document.getElementById('lock-lesson-btn').disabled = true;
        document.getElementById('lock-lesson-btn').textContent = "Bloccato";

        // Disabilita note
        document.getElementById('lesson-notes').disabled = true;
        
        // Disabilita tutti gli slider
        const sliders = document.querySelectorAll('.score-slider');
        sliders.forEach(slider => {
            slider.disabled = true;
        });
    }

    function closeWindow() {
        window.close();
    }
    
    // --- NUOVA FUNZIONE ---
    // Sostituisce closeWindow()
    function goBackToList() {
        showHomeView();
    }
    // --- FINE NUOVA FUNZIONE ---

    // --- FUNZIONI DI RENDERIZZAZIONE UI (MODIFICATE) ---

    function renderQuickCriteria(scores) {
        const container = document.getElementById('quick-criteria-container');
        container.innerHTML = QUICK_CRITERIA.map((criterion, index) => {
            const score = scores[criterion] || 5; // Carica il punteggio salvato o default 5
            return `
            <div class="space-y-1 p-3 bg-gray-50 rounded-lg shadow-inner">
                <label for="quick-slider-${index}" class="block text-sm font-semibold text-gray-700">${index + 1}. ${criterion}</label>
                <p id="quick-desc-${index}" class="text-xs h-8 text-gray-500 overflow-hidden">${SCORE_10_INTERPRETATION[score]}</p>
                <div class="flex items-center space-x-3">
                    <input type="range" min="0" max="10" value="${score}" id="quick-slider-${index}" data-name="${criterion}" data-index="${index}" class="score-slider flex-grow" oninput="updateQuickScore(event)">
                    <span id="quick-value-${index}" class="text-lg font-bold text-indigo-600 w-8 text-right">${score}</span>
                </div>
            </div>
        `}).join('');
    }

    function updateQuickScore(event) {
        if (isPageLocked) return; // Non fare nulla se bloccato
        
        const slider = event.target;
        const name = slider.getAttribute('data-name');
        const index = slider.getAttribute('data-index');
        const value = parseInt(slider.value, 10);
        
        document.getElementById(`quick-value-${index}`).textContent = value;
        document.getElementById(`quick-desc-${index}`).textContent = SCORE_10_INTERPRETATION[value];
        
        quickScores[name] = value;

        // Ricalcola tutto e salva
        const { calculatedScores, competencyAreas, totalScore_0_500 } = calculateScores(quickScores);
        renderDetailedSummary(calculatedScores);
        renderCompetencyAreas(competencyAreas, totalScore_0_500);
        
        // Auto-salva
        saveLessonData(false);
    }

    function renderDetailedSummary(detailedScores) {
        const container = document.getElementById('calculated-scores-container');
        let html = '';

        COMPETENCY_AREAS.forEach((area) => {
            html += `
                <div class="mt-4 mb-3 col-span-full border-b pb-1">
                    <h3 class="text-base font-semibold text-gray-800">${area.name}</h3>
                </div>
            `;
            
            html += `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 col-span-full">`;
            
            area.criteria.forEach(criterionIndex => {
                const criterion = DETAILED_CRITERIA[criterionIndex];
                const score = detailedScores[criterion] || 0;
                const interpretation = SCORE_5_INTERPRETATION[score] || SCORE_5_INTERPRETATION[0];

                html += `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-700 truncate" title="${criterion}">${criterion}</span>
                        <span class="font-bold text-right ml-2 p-1 px-2 rounded-full text-xs ${interpretation.color}">
                            ${score} / 5
                        </span>
                    </div>
                `;
            });

            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    function renderCompetencyAreas(competencyAreas, totalScore) {
        const container = document.getElementById('competency-summary');
        
        container.innerHTML = COMPETENCY_AREAS.map(area => {
            const score = competencyAreas[area.name] || 0;
            
            let color = 'bg-gray-200 text-gray-800';
            if (score >= 40) color = 'bg-green-600 text-white';
            else if (score >= 30) color = 'bg-yellow-400 text-gray-800';
            else color = 'bg-red-400 text-white';

            return `
                <div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 bg-white shadow-sm">
                    <span class="font-medium text-gray-700">${area.name}</span>
                    <span class="px-3 py-1 text-sm font-bold rounded-full ${color}">
                        ${score} / 50
                    </span>
                </div>
            `;
        }).join('');

        document.getElementById('total-score-500').textContent = `${totalScore} / 500`;
    }

    // Esponi le funzioni necessarie all'ambito globale per gli onclick HTML
    window.updateQuickScore = updateQuickScore;
    window.startNewLesson = startNewLesson;
    window.loadSavedLessonsList = loadSavedLessonsList;
    window.deleteLesson = deleteLesson;
    window.saveLessonData = saveLessonData;
    // window.closeWindow = closeWindow; // Vecchia funzione
    window.goBackToList = goBackToList; // Nuova funzione
    window.openLesson = openLesson; // Nuova funzione

</script>
</body>
</html>



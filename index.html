<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Valutazioni Guida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7ff; 
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            margin-bottom: 1.5rem;
        }
        .score-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #e5e7eb; 
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 5px;
            touch-action: none;
        }
        .score-slider:hover { opacity: 1; }
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        .score-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        
        /* FIX TABLET: Impedisce lo scorrimento della pagina quando si interagisce con gli input */
        input[type="text"], textarea {
             touch-action: manipulation;
        }
        
        /* Stili Pulsanti */
        .btn {
            font-weight: 600;
            padding: 0.75rem 1.5rem; 
            border-radius: 0.75rem; 
            transition: all 0.2s;
            text-align: center;
        }
        .btn-primary {
            background-color: #007bff; color: white;
        }
        .btn-primary:hover { background-color: #0069d9; }
        
        .btn-secondary {
            background-color: #6c757d; color: white;
        }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-danger {
            background-color: #dc3545; color: white;
        }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-outline {
            background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6;
        }
        .btn-outline:hover { background-color: #e9ecef; }

        .btn:disabled {
            background-color: #e9ecef; color: #6c757d; cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Stili per la Home Page */
        .saved-lesson-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .saved-lesson-item:last-child { border-bottom: none; }
        
        .date-group-header {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600;
            color: #1f2937; /* text-gray-800 */
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
            /* Aggiunto per il pulsante Elimina Gruppo */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-group-header:first-child {
            margin-top: 0;
        }
        
        .delete-btn {
            background-color: #fef2f2; color: #ef4444; font-weight: bold;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #fecaca;
            line-height: 1;
            flex-shrink: 0;
        }
        .delete-btn:hover { background-color: #fee2e2; }

        .delete-group-btn {
            background-color: #fef2f2; color: #ef4444; font-size: 0.75rem;
            font-weight: 600; border-radius: 0.5rem; padding: 0.25rem 0.75rem;
            border: 1px solid #fecaca;
        }
        .delete-group-btn:hover { background-color: #fee2e2; }
        
        /* Nasconde l'input file, ma lo lascia cliccabile */
        #import-file-input {
            display: none;
        }

        /* Stili per Accordion (Tendina) */
        details summary {
            list-style: none; /* Rimuove la freccia di default */
            cursor: pointer;
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #374151; /* text-gray-700 */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        details summary::after { /* Crea una freccia personalizzata */
            content: '‚ñº';
            font-size: 0.7rem;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(180deg);
        }
        /* Rimuove la freccia di default su Webkit/Safari */
        details summary::-webkit-details-marker {
            display: none;
        }
        details > div {
            padding-top: 1.5rem;
        }

        /* Stili per Gratta e Vinci */
        .scratch-container {
            position: relative;
            width: 80px;
            height: 40px;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }
        .scratch-result {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
        }
        .scratch-result.si { color: #16a34a; } /* green-600 */
        .scratch-result.no { color: #dc2626; } /* red-600 */
        
        .scratch-cover {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #c0c0c0; /* silver */
            background-image: linear-gradient(45deg, #d1d5db 25%, transparent 25%, transparent 75%, #d1d5db 75%, #d1d5db), 
                              linear-gradient(-45deg, #d1d5db 25%, transparent 25%, transparent 75%, #d1d5db 75%, #d1d5db);
            background-size: 6px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            transition: opacity 0.3s;
        }

    </style>
</head>
<body>

<!-- Tooltip personalizzato che verr√† controllato da JS -->
<div id="custom-tooltip" class="hidden absolute z-50 p-2 bg-gray-800 text-white text-sm rounded-lg shadow-lg max-w-xs" style="pointer-events: none; transition: opacity 0.1s ease;">
</div>

<!-- 
    PAGINA DI AVVIO (LANDING PAGE)
-->
<div id="home-view" class="container">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-6 text-center">
        Registro Valutazioni Guida
    </h1>
    
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Crea Nuova Valutazione</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="student-name-input" placeholder="Nome e Cognome Allievo/a" class="flex-grow w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button id="start-lesson-btn" onclick="startNewLesson()" class="btn btn-primary">
                Inizia Valutazione
            </button>
        </div>
        <p id="landing-error" class="text-red-600 text-sm mt-2 hidden"></p>
    </div>
    
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Valutazioni Salvate</h2>
        <div id="saved-lessons-list" class="space-y-2">
            <!-- Elenco caricato da JS -->
        </div>
    </div>
    
    <!-- Box Backup e Ripristino -->
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Backup e Ripristino</h2>
        <p class="text-sm text-gray-600 mb-4">
            Salva tutti i tuoi dati in un file, o ricarica un file di backup.
        </p>
        <div class="grid grid-cols-2 gap-4">
            <button id="export-btn" class="btn btn-primary">
                Esporta Dati
            </button>
            <input type="file" id="import-file-input" accept=".json" onchange="importData(event)">
            <button id="import-btn" class="btn btn-outline">
                Importa Dati
            </button>
            <!-- Pulsante Resetta Dati Aggiunto -->
            <button id="reset-all-btn" onclick="deleteAllData()" class="btn btn-danger col-span-2">
                Resetta Tutti i Dati
            </button>
        </div>
        <p id="import-status" class="text-sm mt-3"></p>
    </div>
</div>

<!-- 
    PAGINA CALCOLATORE (APP PRINCIPALE)
-->
<div id="calculator-page" class="container hidden">
    <!-- SEZIONE GESTIONE E SALVATAGGIO -->
    <div id="management-section" class="card">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">
                    <span id="student-name-display" class="text-blue-600">...</span>
                </h1>
                <p id="lock-status" class="text-sm font-medium text-gray-500">
                    Stato: <span class="text-green-600">In corso...</span>
                </p>
            </div>
            <!-- Pulsanti Salva/Indietro spostati in fondo -->
        </div>
    </div>

    <!-- VALUTAZIONE RAPIDA (1) -->
    <div id="valuation-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Valutazione Guida</h2>
        <p class="text-sm text-gray-600 mb-4">
            Assegna una valutazione. La descrizione di supporto appare tenendo premuta l'emoticon.
        </p>

        <div id="quick-criteria-container" class="grid lg:grid-cols-3 md:grid-cols-2 gap-x-8 gap-y-6">
            <!-- I criteri rapidi sono inseriti dal JS -->
        </div>

        <div class="mt-8">
            <label for="lesson-notes" class="block text-sm font-medium text-gray-700 mb-2">Note della Lezione (Opzionale):</label>
            <textarea id="lesson-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="saveLessonData(false)"></textarea>
        </div>
        
        <div class="mt-8">
            <label class="block text-sm font-medium text-gray-700 mb-3">Moduli Obbligatori Svolti:</label>
            <div id="moduli-container" class="space-y-3">
                <!-- Opzione 1: Nessuno -->
                <div>
                    <input type="radio" id="modulo_nessuno" name="modulo_obbligatorio" value="nessuno" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)" checked>
                    <label for="modulo_nessuno" class="ml-2 text-sm font-medium text-gray-900">Nessuno</label>
                </div>
                <!-- Opzione 2: Modulo A -->
                <div>
                    <input type="radio" id="modulo_a" name="modulo_obbligatorio" value="A" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)">
                    <label for="modulo_a" class="ml-2 text-sm font-medium text-gray-900">Modulo A</label>
                    <p class="text-xs text-gray-600 ml-6 pl-1">La guida in condizioni di visione notturna, Circolazione su strade urbane strette e larghe, con veicoli parcheggiati ai lati e non, affrontando incroci regolati da segnaletica verticale e da impianti semaforici.</p>
                </div>
                <!-- Opzione 3: Modulo B -->
                <div>
                    <input type="radio" id="modulo_b" name="modulo_obbligatorio" value="B" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)">
                    <label for="modulo_b" class="ml-2 text-sm font-medium text-gray-900">Modulo B</label>
                    <p class="text-xs text-gray-600 ml-6 pl-1">Guida su strade extraurbane, Circolazione su strade urbane di scorrimento, o su strade extraurbane secondarie, utilizzando il veicolo ed il motore a regime di copia massima consumando e inquinando il minimo possibile.</p>
                </div>
                <!-- Opzione 4: Modulo C -->
                <div>
                    <input type="radio" id="modulo_c" name="modulo_obbligatorio" value="C" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)">
                    <label for="modulo_c" class="ml-2 text-sm font-medium text-gray-900">Modulo C</label>
                    <p class="text-xs text-gray-600 ml-6 pl-1">Guida su autostrade o su strade extraurbane, Circolazione su autostrade o su strade extraurbane principali o su strade extraurbane secondarie superando la velocit√† di 50 Km/h, utilizzando la 5^ marcia e adeguando le marce alla velocit√†.</p>
                </div>
            </div>
        </div>
        
    </div>

    <!-- PUNTEGGIO TOTALE (2) - Spostato e Grattabile -->
    <div id="total-score-section" class="card">
        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg flex justify-between items-center">
            <span class="text-lg font-bold text-indigo-800">Punteggio Totale Calcolato:</span>
            
            <!-- Contenitore Grattabile per il Punteggio -->
            <div class="scratch-container" style="width: 160px; height: 50px; border-radius: 0.5rem;">
                <div id="result-total-score" class="scratch-result">
                    <span id="total-score-500" class="text-2xl font-extrabold text-indigo-800">0 / 500</span>
                </div>
                <div id="cover-total-score" class="scratch-cover" onclick="reveal('total-score')" style="border-radius: 0.5rem; font-size: 0.875rem;">
                    GRATTA QUI
                </div>
            </div>
        </div>
    </div>


    <!-- RIEPILOGO AREE DI COMPETENZA (3) - A tendina -->
    <div id="competency-section-wrapper" class="card">
        <details>
            <!-- Titolo modificato -->
            <summary>3. Riepilogo Aree di Competenza</summary>
            <div id="competency-summary" class="grid md:grid-cols-2 gap-4">
                <!-- I punteggi delle 10 aree saranno qui -->
            </div>
        </details>
    </div>

    <!-- RIEPILOGO DETTAGLIATO CALCOLATO (4) - A tendina -->
    <div id="detailed-summary-section-wrapper" class="card">
        <details>
            <summary>
                <!-- Titolo modificato -->
                4. Riepilogo Dettagliato
            </summary>
            <div id="calculated-scores-container">
                <!-- I punteggi dettagliati raggruppati saranno inseriti qui -->
            </div>
        </details>
    </div>
    
    <!-- PREVISIONE ESAME (5) - Nuovo, a tendina e rinominato -->
    <div id="exam-prediction-section" class="card">
        <details>
            <summary>5. Patentometro</summary>
            <div>
                <p class="text-sm text-gray-600 mb-6">
                    Clicca o "gratta" il riquadro argentato per rivelare il risultato.
                </p>
                
                <div id="exam-items-container" class="space-y-4">
                    <!-- I 24 criteri d'esame saranno inseriti qui da JS -->
                </div>
            </div>
        </details>
    </div>


    <!-- Box Salvataggio (Senza conferma) -->
    <div id="save-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">6. Salva e Completa</h2>
        
        <div id="confirmation-container">
            <p class="text-sm text-gray-600 mb-4">
                Clicca "Salva" per archiviare la valutazione. Non potrai pi√π modificarla.
            </p>
        </div>
        
        <div id="confirmation-display" class="hidden">
        </div>

        <!-- Pulsanti di azione -->
        <div class="flex flex-col sm:flex-row gap-4 mt-6">
            <button id="lock-lesson-btn" onclick="saveAndLockLesson()" class="btn btn-danger flex-1">
                Salva
            </button>
            <button onclick="goBackToList()" class="btn btn-secondary flex-1">
                Indietro
            </button>
        </div>
    </div>
</div>

<!-- LOGICA JAVASCRIPT E STORAGE -->
<script type="module">

    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpYgIOc0xlgRdMxTlPzCaZfFtjwFd8WVfHnTP7yUoMOxkmQxH4Iq5qEGwZAh5BKNXq/exec";

    let currentLessonId = null;
    let quickScores = {}; 
    
    // Tooltip personalizzato
    const tooltip = document.getElementById('custom-tooltip');

    // Mappatura Emoticon (Richiesta 1 - INVERTITE 9 e 10)
    const EMOJI_INTERPRETATION = {
        0: "üò∂", 1: "üò±", 2: "üò®", 3: "üò£", 4: "ü§î",
        5: "üßê", 6: "üôÇ", 7: "üòä", 8: "üòÑ", 9: "ü§©", 10: "üòé"
    };

    // 1. Mappatura Descrizioni 0-10
    const SCORE_10_INTERPRETATION = {
        0: "Non ancora spiegato ‚Üí L'argomento o la manovra non √® stata ancora trattata.",
        1: "Grave errore ‚Üí Tentativo fallito, comportamento inadeguato.",
        2: "Molto insicuro ‚Üí Errori gravi, necessit√† di intervento.",
        3: "Insicuro ‚Üí Errori evidenti, esecuzione incerta.",
        4: "Migliorabile ‚Üí Errori non gravi, ma guida imprecisa.", // Corretto: Rimosso punto dopo '4'
        5: "Quasi sufficiente ‚Üí Autonomia parziale, migliorabile.",
        6: "Sufficiente ‚Üí Controllo adeguato, ma con margini di miglioramento.",
        7: "Discreto ‚Üí Guida sicura con qualche imprecisione.",
        8: "Buono ‚Üí Buon controllo del veicolo e sicurezza elevata.",
        9: "Distinto ‚Üí Guida fluida con anticipazione dei rischi.",
        10: "Ottimo ‚Üí Controllo totale, sicurezza massima."
    };

    // 2. Lista dei 20 criteri rapidi (Scala 0-10)
    const QUICK_CRITERIA = [
        "Sguardo", "Fluidit√† nel volante", "Accelerazione in partenza", "Modulazione della frenata", "Fluidit√† nel cambio", "Utilizzo della frizione", "Partenza in salita", "Posizione del veicolo su strada", "Svolta a destra", "Svolta a sinistra", "Comportamento negli incroci", "Punto morto", "Voltarsi nelle retromarce", "Inversione di marcia", "Parcheggi in retromarcia", "Accostare il veicolo", "Padronanza delle situazioni", "Postura di guida", "Regolazione e uso degli specchi retrovisori", "Uso e conoscenza dei dispositivi e teoria motore"
    ];

    // 3. Lista dei 77 criteri dettagliati (Scala 0-5)
    const DETAILED_CRITERIA = [
        "Regolazione sedile in distanza, altezza ed inclinazione", "Regolazione specchi, poggiatesta e cintura", "Posizione corretta delle mani", "Uso volante in curva aperta dx sx", "Uso volante in curva media dx sx", "Uso volante in curva stretta dx sx", "Uso volante in svolta dx sx", "Uso visione centrale e direzione del veicolo", "Uso visione periferica", "Dinamicit√† dello sguardo", "Capacit√† di anticipazione visiva", "Corretto utilizzo sguardo in curva a destra", "Corretto utilizzo sguardo in curva a sinistra", "Corretta sequenza rti (retrovisori, testa, indicatore)", "Sensibilit√† all'uso dell'acceleratore", "Sensibilit√† uso freno frenata degressiva", "Passaggio freno acceleratore ancoraggio tacco", "Frenata di precisione rispetto ad un punto d'arresto predeterminato", "Frenata in situazioni di pericolo", "Corretto utilizzo del piede sulla frizione", "Piede su passaruota con frizione a riposo", "Ricerca innesto frizione", "Tenuta pedale dopo innesto", "Combinazione gas frizione in partenza", "Partenza in pianura discesa", "Partenza in salita", "Impostazioni mano su cambio", "Incremento marce seconda e terza", "Decremento marce terza e seconda", "Sequenza completa incremento marce", "Sequenza completa scalata marce", "Preparazione cambiata anticipo mano", "Incremento marce con equilibrio volante", "Scalata tenuta freno e uso frizione", "Coordinazione motoria frizione cambio volante", "Svolta a sx su strada a doppio senso (posizione, esecuzione)", "Svolta a sx su strada a senso unico (posizione, esecuzione)", "Svolta a destra (posizione esecuzione)", "Comportamenti alle rotatorie", "Comportamento in preselezione di incrocio", "Rispetto della segnaletica agli incroci", "Capacit√† di adattamento al buio", "Comportamento nei confronti dei veicoli che provengono dalla direzione opposta, anche in caso di spazio limitato", "Superamento di ostacoli (vetture parcheggiate, ostacoli in genere)", "Comportamento alle fermate di bus/tram", "Rispetto degli attraversamenti pedonali e dei comportamenti correlati ai pedoni", "Guida proattiva - Capacit√† di prevenire il pericolo", "Capacit√† di adattamento velocit√† alla strada ed ai suoi limiti", "Corretto utilizzo del cambio di velocit√† (eco)", "Comprensione del punto di cambiata", "Utilizzo razionale dell'inerzia (eco roll)", "Utilizzo razionale del freno motore (cut-off)", "Rispetto delle distanze di sicurezza", "Ingresso su corsia di accelerazione", "Inserimento nel traffico in condizioni di sicurezza", "Capacit√† di valutazione delle distanze ed adattamento al traffico", "Uso corretto degli specchi retrovisori nella fase di inizio del sorpasso", "Corretta gestione del volante nella fase di inizio e fine sorpasso", "Rientro dal sorpasso in sicurezza (specchi, ecc)", "Uscita su strade a precedenza mediante corsia di decelerazione", "Retromarcia in rettilineo", "Retromarcia ad L con svolta a sinistra", "Retromarcia ad L con svolta a destra", "Inversione di marcia con marcia avanti", "Inversione di marcia in retromarcia", "Parcheggi in retromarcia parallelo a destra", "Parcheggi in retromarcia parallelo a sinistra", "Parcheggio in retromarcia su strada in pendenza", "Parcheggio a pettine (in retromarcia ed in avanti)", "Parcheggio a spina (in retromarcia ed in avanti)", "Controllo carta di circolazione", "Controllo pneumatici", "Controllo sterzo e comandi sul volante", "Controllo livelli", "Controllo dispositivi di segnalazione visiva ed illuminazione", "Controllo corretta chiusura porte - cofano motore", "Corrette operazioni nella discesa dal veicolo"
    ];

    // Mappatura delle interpretazioni del punteggio (Scala 0-5)
    const SCORE_5_INTERPRETATION = {
        0: { text: "Non trattato / Grave", color: "bg-red-200 text-red-800" },
        1: { text: "Grave / Intervento", color: "bg-red-200 text-red-800" },
        2: { text: "Migliorabile / Imprecisa", color: "bg-yellow-200 text-yellow-800" },
        3: { text: "Sufficiente / Adeguato", color: "bg-green-200 text-green-800" },
        4: { text: "Buono / Fluida", color: "bg-green-200 text-green-800" },
        5: { text: "Ottimo / Controllo totale", color: "bg-green-200 text-green-800" }
    };

    // Mappatura delle 10 Aree di Competenza ai criteri dettagliati
    const COMPETENCY_AREAS = [
        { name: "1. Postura, Sguardo, Volante", criteria: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13] },
        { name: "2. Acceleratore e Freno", criteria: [14, 15, 16, 17, 18] },
        { name: "3. Frizione e Cambio", criteria: [19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34] },
        { name: "4. Incroci e Svolte", criteria: [35, 36, 37, 38, 39, 40] },
        { name: "5. Guida Notturna Urbana - Mod. A", criteria: [41, 42, 43, 44, 45, 46] },
        { name: "6. Guida Extraurbana ed EcoGuida - Mod. B", criteria: [47, 48, 49, 50, 51, 52] },
        { name: "7. Guida in Autostrada - Mod. C", criteria: [53, 54, 55, 56, 57, 58, 59] },
        { name: "8. Retromarcia ed Inversione", criteria: [60, 61, 62, 63, 64] },
        { name: "9. Parcheggi", criteria: [65, 66, 67, 68, 69] },
        { name: "10. Fase I Esame", criteria: [70, 71, 72, 73, 74, 75, 76] }
    ];
    
    // Lista dei 24 Criteri d'Esame
    const EXAM_CRITERIA = {
        'a': "Azione sul volante",
        'b': "Azione sul cambio",
        'c': "Uso sulla frizione",
        'd': "Spunto in salita",
        'e': "Manovre parcheggio",
        'f': "Azionamento altri comandi",
        'g': "Svolta a destra e sinistra",
        'h': "Attraversamento incroci",
        'i': "Mano da tenere",
        'l': "Rispetto segnaletica orizzontale",
        'm': "Rispetto segnaletica",
        'n': "Transito in rotatorie",
        'o': "Transito in sensi unici",
        'p': "Strade pluricorsie",
        'q': "Conversione ad U",
        'r': "Sorpasso",
        's': "Rispetto delle precedenze",
        't': "Distanze di sicurezza",
        'u': "Velocit√† adeguata",
        'v': "Corretta positura nell'osservazione",
        'z': "Tempestivit√† nell'osservazione",
        'x': "Valutazione del pericolo"
    };


    /**
     * Esegue l'arrotondamento a soglia (0.5 -> 0, 0.51 -> 1), come nel foglio di calcolo.
     */
    function customRound(value) {
        if (value <= 0.5) return 0;
        if (value <= 1.5) return 1;
        if (value <= 2.5) return 2;
        if (value <= 3.5) return 3;
        if (value <= 4.5) return 4;
        return 5; 
    }

    /**
     * Calcola la media dei punteggi (0-5) per un set di criteri dettagliati.
     */
    function calculateAreaScore(indices, detailedScores) {
        let sum = 0;
        let count = 0;

        indices.forEach(index => {
            const criterionName = DETAILED_CRITERIA[index];
            const score = detailedScores[criterionName];
            if (typeof score === 'number') {
                sum += score;
                count++;
            }
        });

        const average_0_5_raw = count > 0 ? sum / count : 0;
        
        // Punteggio 0-50 per il totale
        const score_0_50 = Math.min(50, Math.max(0, parseFloat((average_0_5_raw * 10).toFixed(0))));
        
        // Punteggio 0-5 per la visualizzazione (con un decimale)
        const average_0_5_display = parseFloat(average_0_5_raw.toFixed(1));

        return { score_0_50, average_0_5_display };
    }


    /**
     * Applica le 77 formule complesse e calcola le 10 aree di competenza.
     */
    function calculateScores(quickScores) {
        const calculatedScores = {};
        const q = QUICK_CRITERIA.map(name => quickScores[name] || 0);
        // Helper per mappare B(n) a q[n-2]
        // Esempio: B2 -> q[0], B3 -> q[1], B19 -> q[17], B21 -> q[19]
        const getQ = (index) => q[index] || 0; 

        const formulas = [
            (q) => (getQ(17) * 1) / 2, // 1. Regolazione sedile (B19)
            (q) => (getQ(18) * 0.5 + getQ(17) * 0.5) / 2, // 2. Regolazione specchi (B20, B19)
            (q) => (getQ(17) * 1) / 2, // 3. Posizione mani (B19)
            (q) => (getQ(1) * 0.5 + getQ(8) * 0.25 + getQ(9) * 0.25) / 2, // 4. Volante aperta (B3, B10, B11)
            (q) => (getQ(1) * 0.4 + getQ(8) * 0.3 + getQ(9) * 0.3) / 2, // 5. Volante media (B3, B10, B11)
            (q) => (getQ(1) * 0.5 + getQ(8) * 0.25 + getQ(9) * 0.25) / 2, // 6. Volante stretta (B3, B10, B11)
            (q) => (getQ(1) * 0.6 + getQ(8) * 0.2 + getQ(9) * 0.2) / 2, // 7. Volante svolta (B3, B10, B11)
            (q) => (getQ(0) * 1) / 2, // 8. Visione centrale (B2)
            (q) => (getQ(0) * 1) / 2, // 9. Visione periferica (B2)
            (q) => (getQ(0) * 1) / 2, // 10. Dinamicit√† sguardo (B2)
            (q) => (getQ(0) * 1) / 2, // 11. Anticipazione visiva (B2)
            (q) => (getQ(0) * 0.5 + getQ(8) * 0.5) / 2, // 12. Sguardo curva dx (B2, B10)
            (q) => (getQ(0) * 0.5 + getQ(9) * 0.5) / 2, // 13. Sguardo curva sx (B2, B11)
            (q) => (getQ(18) * 0.4 + getQ(10) * 0.1 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(15) * 0.1) / 2, // 14. Sequenza rti (B20, B12, B2, B9, B17)
            (q) => (getQ(2) > 0 ? (getQ(2) * 0.5 + getQ(0) * 0.5) : 0) / 2, // 15. Sensibilit√† acceleratore (SE B4>0; B4, B2)
            (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.5) : 0) / 2, // 16. Sensibilit√† freno (SE B5>0; B5, B2)
            (q) => (getQ(2) > 0 ? (getQ(17) * 1) : 0) / 2, // 17. Passaggio freno (SE B4>0; B19)
            (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.25 + getQ(15) * 0.25) : 0) / 2, // 18. Frenata precisione (SE B5>0; B5, B2, B17)
            (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.25 + getQ(16) * 0.25) : 0) / 2, // 19. Frenata pericolo (SE B5>0; B5, B2, B18)
            (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, // 20. Uso piede frizione (SE B7>0; B7, B19)
            (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, // 21. Piede passaruota (SE B7>0; B7, B19)
            (q) => (getQ(5) > 0 ? (getQ(5) * 1) : 0) / 2, // 22. Ricerca innesto (SE B7>0; B7)
            (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, // 23. Tenuta pedale (SE B7>0; B7, B19)
            (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(2) * 0.5) : 0) / 2, // 24. Combinazione gas frizione (SE B7>0; B7, B4)
            (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(2) * 0.5) : 0) / 2, // 25. Partenza pianura (SE B7>0; B7, B4)
            (q) => (getQ(6) * 1) / 2, // 26. Partenza salita (B8)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(17) * 0.5) : 0) / 2, // 27. Impostazioni mano cambio (SE B6>0; B6, B19)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.7 + getQ(5) * 0.3) : 0) / 2, // 28. Incremento 2-3 (SE B6>0; B6, B7)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.7 + getQ(5) * 0.2 + getQ(3) * 0.1) : 0) / 2, // 29. Decremento 3-2 (SE B6>0; B6, B7, B5)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(5) * 0.25 + getQ(7) * 0.25) : 0) / 2, // 30. Seq completa incremento (SE B6>0; B6, B7, B9)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(5) * 0.2 + getQ(3) * 0.2 + getQ(7) * 0.1) : 0) / 2, // 31. Seq completa scalata (SE B6>0; B6, B7, B5, B9)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(17) * 0.5) : 0) / 2, // 32. Preparazione cambiata (SE B6>0; B6, B19)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(1) * 0.5) : 0) / 2, // 33. Incremento equilibrio (SE B6>0; B6, B3)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(3) * 0.25 + getQ(5) * 0.25) : 0) / 2, // 34. Scalata tenuta freno (SE B6>0; B6, B5, B7)
            (q) => (getQ(4) > 0 ? (getQ(4) * 0.25 + getQ(3) * 0.25 + getQ(5) * 0.25 + getQ(1) * 0.25) : 0) / 2, // 35. Coordinazione (SE B6>0; B6, B5, B7, B3)
            (q) => (getQ(9) * 1) / 2, // 36. Svolta sx doppio senso (B11)
            (q) => (getQ(9) * 1) / 2, // 37. Svolta sx senso unico (B11)
            (q) => (getQ(8) * 1) / 2, // 38. Svolta dx (B10)
            (q) => (getQ(10) * 1) / 2, // 39. Rotatorie (B12)
            (q) => (getQ(10) * 0.8 + getQ(0) * 0.1 + getQ(16) * 0.1) / 2, // 40. Preselezione incrocio (B12, B2, B18)
            (q) => (getQ(10) * 0.8 + getQ(0) * 0.1 + getQ(16) * 0.1) / 2, // 41. Rispetto segnaletica (B12, B2, B18)
            (q) => (getQ(0) * 0.75 + getQ(16) * 0.25) / 2, // 42. Adattamento buio (B2, B18)
            (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, // 43. Veicoli opposti (B12, B2, B9, B21)
            (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, // 44. Superamento ostacoli (B12, B2, B9, B21)
            (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, // 45. Fermate bus (B12, B2, B9, B21)
            (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, // 46. Attraversamenti pedonali (B12, B2, B9, B21)
            (q) => (getQ(0) * 0.5 + getQ(16) * 0.5) / 2, // 47. Guida proattiva (B2, B18)
            (q) => (getQ(2) * 0.5 + getQ(3) * 0.5) / 2, // 48. Adattamento velocit√† (B4, B5)
            (q) => (getQ(4) * 0.5 + getQ(7) * 0.5) / 2, // 49. Uso cambio eco (B6, B9)
            (q) => (getQ(4) * 1) / 2, // 50. Comprensione punto cambiata (B6)
            (q) => (getQ(4) * 0.5 + getQ(5) * 0.5) / 2, // 51. Inerzia eco roll (B6, B7)
            (q) => (getQ(3) * 0.2 + getQ(4) * 0.8) / 2, // 52. Freno motore cut-off (B5, B6)
            (q) => (getQ(0) * 0.5 + getQ(7) * 0.5) / 2, // 53. Distanze sicurezza (B2, B9)
            (q) => (getQ(10) * 1) / 2, // 54. Ingresso accelerazione (B12)
            (q) => (getQ(7) * 0.2 + getQ(1) * 0.2 + getQ(2) * 0.2 + getQ(5) * 0.2 + getQ(11) * 0.2) / 2, // 55. Inserimento traffico (B9, B3, B4, B7, B13)
            (q) => (getQ(0) * 0.5 + getQ(7) * 0.5) / 2, // 56. Valutazione distanze (B2, B9)
            (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, // 57. Uso specchi sorpasso (B20, B21)
            (q) => (getQ(1) * 1) / 2, // 58. Gestione volante sorpasso (B3)
            (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, // 59. Rientro sorpasso (B20, B21)
            (q) => (getQ(10) * 1) / 2, // 60. Uscita decelerazione (B12)
            (q) => (getQ(12) > 0 ? (getQ(12) * 1) : 0) / 2, // 61. Retromarcia rettilineo (SE B14>0; B14)
            (q) => (getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(9) * 0.2) : 0) / 2, // 62. Retromarcia L sx (SE B14>0; B14, B11)
            (q) => (getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(8) * 0.2) : 0) / 2, // 63. Retromarcia L dx (SE B14>0; B14, B10)
            (q) => (getQ(13) * 1) / 2, // 64. Inversione avanti (B15)
            (q) => (getQ(13) * 1) / 2, // 65. Inversione retro (B15)
            (q) => (getQ(14) * 1) / 2, // 66. Parcheggi parallelo dx (B16)
            (q) => (getQ(14) * 1) / 2, // 67. Parcheggi parallelo sx (B16)
            (q) => (getQ(14) * 1) / 2, // 68. Parcheggio pendenza (B16)
            (q) => (getQ(14) * 1) / 2, // 69. Parcheggio pettine (B16)
            (q) => (getQ(14) * 1) / 2, // 70. Parcheggio spina (B16)
            (q) => (getQ(19) * 1) / 2, // 71. Controllo carta circolazione (B21)
            (q) => (getQ(19) * 1) / 2, // 72. Controllo pneumatici (B21)
            (q) => (getQ(19) * 1) / 2, // 73. Controllo sterzo (B21)
            (q) => (getQ(19) * 1) / 2, // 74. Controllo livelli (B21)
            (q) => (getQ(19) * 1) / 2, // 75. Controllo dispositivi (B21)
            (q) => (getQ(19) * 1) / 2, // 76. Controllo chiusura (B21)
            (q) => (getQ(19) * 1) / 2  // 77. Operazioni discesa (B21)
        ];

        DETAILED_CRITERIA.forEach((criterion, index) => {
            try {
                const decimalResult = formulas[index](q);
                calculatedScores[criterion] = customRound(decimalResult);
            } catch (e) {
                console.error(`Errore nel calcolo del criterio ${criterion} (indice ${index}):`, e);
                calculatedScores[criterion] = 0; 
            }
        });

        const competencyAreas_0_50 = {};
        const competencyAreas_0_5 = {};
        let totalScore_0_500 = 0;

        COMPETENCY_AREAS.forEach(area => {
            const { score_0_50, average_0_5_display } = calculateAreaScore(area.criteria, calculatedScores);
            
            competencyAreas_0_50[area.name] = score_0_50;
            competencyAreas_0_5[area.name] = average_0_5_display;
            
            totalScore_0_500 += score_0_50;
        });

        return { calculatedScores, competencyAreas_0_50, competencyAreas_0_5, totalScore_0_500 };
    }
    
    /**
     * Calcola la previsione d'esame
     * Logica: Mappa i 77 Criteri Dettagliati (0-5) ai 24 Criteri d'Esame (output)
     */
    function calculateExamPredictionFromDetailed(detailedScores) {
        const predictions = {};
        const threshold = 3; // "Sufficiente" (>= 3) sulla scala 0-5
        const isSI = (val) => val >= threshold ? "SI" : "NO";
        
        // Helper: Calcola la media dei punteggi (0-5) per un set di indici di criteri dettagliati
        const avgDetailed = (indices) => {
            let sum = 0;
            let count = 0;
            indices.forEach(index => {
                const score = detailedScores[DETAILED_CRITERIA[index]];
                if (typeof score === 'number') {
                    sum += score;
                    count++;
                }
            });
            return count > 0 ? (sum / count) : 0;
        };

        // Mappatura (Proxy) dai 77 Criteri Dettagliati (0-5)
        predictions.a = isSI(avgDetailed([3, 4, 5, 6])); // "Azione sul volante" -> Media "Uso volante..."
        predictions.b = isSI(avgDetailed([27, 28, 29, 30, 31])); // "Azione sul cambio" -> Media "Incremento/decremento marce"
        predictions.c = isSI(avgDetailed([19, 20, 21, 22, 23, 24])); // "Uso sulla frizione" -> Media "Uso piede frizione", "Ricerca innesto", etc.
        predictions.d = isSI(detailedScores[DETAILED_CRITERIA[25]]); // "Spunto in salita" -> "Partenza in salita"
        predictions.e = isSI(avgDetailed([65, 66, 67, 68, 69])); // "Manovre parcheggio" -> Media "Parcheggi..."
        predictions.f = isSI(avgDetailed([72, 74])); // "Azionamento altri comandi" -> Media "Controllo sterzo/comandi", "Controllo dispositivi"
        predictions.g = isSI(avgDetailed([35, 36, 37])); // "Svolta a destra e sinistra" -> Media "Svolta sx...", "Svolta dx..."
        predictions.h = isSI(avgDetailed([39, 40])); // "Attraversamento incroci" -> Media "Preselezione", "Rispetto segnaletica"
        predictions.i = isSI(avgDetailed([42, 43, 44, 45])); // "Mano da tenere" -> Proxy: Media "Comportamento veicoli opposti", "Superamento ostacoli", etc.
        predictions.l = isSI(detailedScores[DETAILED_CRITERIA[40]]); // "Rispetto segnaletica orizzontale" -> "Rispetto segnaletica"
        predictions.m = isSI(detailedScores[DETAILED_CRITERIA[40]]); // "Rispetto segnaletica" -> "Rispetto segnaletica"
        predictions.n = isSI(detailedScores[DETAILED_CRITERIA[38]]); // "Transito in rotatorie" -> "Comportamenti alle rotatorie"
        predictions.o = isSI(detailedScores[DETAILED_CRITERIA[36]]); // "Transito in sensi unici" -> "Svolta a sx su strada a senso unico"
        predictions.p = isSI(avgDetailed([53, 54, 55, 59])); // "Strade pluricorsie" -> Media "Ingresso accelerazione", "Inserimento", "Uscita"
        predictions.q = isSI(avgDetailed([63, 64])); // "Conversione ad U" -> Media "Inversione..."
        predictions.r = isSI(avgDetailed([56, 57, 58])); // "Sorpasso" -> Media "Uso specchi", "Gestione volante", "Rientro"
        predictions.s = isSI(detailedScores[DETAILED_CRITERIA[40]]); // "Rispetto delle precedenze" -> "Rispetto segnaletica incroci"
        predictions.t = isSI(detailedScores[DETAILED_CRITERIA[52]]); // "Distanze di sicurezza" -> "Rispetto distanze di sicurezza"
        predictions.u = isSI(detailedScores[DETAILED_CRITERIA[47]]); // "Velocit√† adeguata" -> "Capacit√† adattamento velocit√†"
        predictions.v = isSI(avgDetailed([7, 8, 9, 10, 11, 12])); // "Corretta positura nell'osservazione" -> Media "Uso visione...", "Dinamicit√† sguardo"
        predictions.z = isSI(detailedScores[DETAILED_CRITERIA[13]]); // "Tempestivit√† nell'osservazione" -> "Corretta sequenza rti"
        predictions.x = isSI(detailedScores[DETAILED_CRITERIA[46]]); // "Valutazione del pericolo" -> "Guida proattiva"
        
        return predictions;
    }


    // --- FUNZIONI DI GESTIONE PAGINA (Single Page App) ---

    // Chiamata all'avvio
    function initPage() {
        // Popola la Sezione Esame con la struttura base
        const defaultQuickScores = {};
        QUICK_CRITERIA.forEach(name => { defaultQuickScores[name] = 5; });
        const defaultDetailedScores = calculateScores(defaultQuickScores).calculatedScores;
        const defaultPredictions = calculateExamPredictionFromDetailed(defaultDetailedScores);
        renderExamPredictions(defaultPredictions);
        
        showHomeView();
    }

    function showHomeView() {
        document.getElementById('home-view').classList.remove('hidden');
        document.getElementById('calculator-page').classList.add('hidden');
        document.getElementById('student-name-input').value = ""; // Pulisce l'input
        loadSavedLessonsList(); // Ricarica la lista
        
        // Collega i pulsanti Import/Export
        document.getElementById('export-btn').onclick = exportData;
        document.getElementById('import-btn').onclick = () => document.getElementById('import-file-input').click();
    }

    function showCalculatorPage(lessonId) {
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('calculator-page').classList.remove('hidden');
        
        // Resetta le tendine (chiudile)
        document.querySelectorAll('#calculator-page details').forEach(el => el.open = false);
        
        // Resetta i "grattabili"
        document.querySelectorAll('.scratch-cover').forEach(el => {
            el.classList.remove('hidden');
            el.style.opacity = '1';
        });

        loadLesson(lessonId); // Carica i dati dell'allievo specifico
    }

    function startNewLesson() {
        const studentNameInput = document.getElementById('student-name-input');
        const studentName = studentNameInput.value.trim();
        const errorEl = document.getElementById('landing-error');
        
        if (studentName.length < 3) {
            errorEl.textContent = "Il nome deve essere di almeno 3 caratteri.";
            errorEl.classList.remove('hidden');
            return;
        }
        errorEl.classList.add('hidden');

        const lessonId = `lesson_${new Date().getTime()}`;
        const defaultQuickScores = {};
        QUICK_CRITERIA.forEach(name => {
            defaultQuickScores[name] = 5;
        });

        const lessonData = {
            id: lessonId,
            studentName: studentName,
            createdAt: new Date().toISOString(),
            notes: "",
            moduloSvolto: "nessuno",
            quickScores: defaultQuickScores,
            isLocked: false,
            finalScore: null
            // Campi conferma rimossi
        };

        localStorage.setItem(lessonId, JSON.stringify(lessonData));
        
        showCalculatorPage(lessonId);
    }

    function getRelativeDateGroup(dateString) {
        if (!dateString || isNaN(new Date(dateString).getTime())) {
            return "Senza Data";
        }
        
        const today = new Date();
        const date = new Date(dateString);
        
        today.setHours(0, 0, 0, 0);
        date.setHours(0, 0, 0, 0);

        const diffTime = today.getTime() - date.getTime();
        const diffDays = diffTime / (1000 * 60 * 60 * 24);

        if (diffDays === 0) {
            return "Oggi";
        } else if (diffDays === 1) {
            return "Ieri";
        } else {
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
    }

    function loadSavedLessonsList() {
        const listContainer = document.getElementById('saved-lessons-list');
        listContainer.innerHTML = '';
        
        const lessons = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('lesson_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && data.id && data.studentName) {
                        lessons.push(data);
                    }
                } catch (e) {
                    console.warn(`Impossibile parsare i dati per ${key}`);
                }
            }
        }

        if (lessons.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500">Nessuna valutazione salvata.</p>';
            return;
        }
        
        // Raggruppa le lezioni per data
        const groupedLessons = {};
        lessons.forEach(lesson => {
            const dateGroup = getRelativeDateGroup(lesson.createdAt);
            if (!groupedLessons[dateGroup]) {
                groupedLessons[dateGroup] = [];
            }
            groupedLessons[dateGroup].push(lesson);
        });

        // Ordina i gruppi di date
        const sortedGroups = Object.keys(groupedLessons).sort((a, b) => {
            if (a === "Oggi") return -1;
            if (b === "Oggi") return 1;
            if (a === "Ieri") return -1;
            if (b === "Ieri") return 1;
            if (a === "Senza Data") return 1;
            if (b === "Senza Data") return -1;
            // Ordina le altre date (es. 01/11/2025) dalla pi√π recente
            const dateA = new Date(a.split('/').reverse().join('-'));
            const dateB = new Date(b.split('/').reverse().join('-'));
            return dateB - dateA;
        });

        // Itera sui gruppi ordinati e mostra
        sortedGroups.forEach(dateGroup => {
            const lessonsInGroup = groupedLessons[dateGroup];
            const lessonIdsInGroup = lessonsInGroup.map(l => l.id).join(',');
            
            const groupHeader = document.createElement('div');
            groupHeader.className = 'date-group-header';
            groupHeader.innerHTML = `
                <span>${dateGroup} (${lessonsInGroup.length})</span>
                <button class="delete-group-btn" onclick="deleteLessonsByGroup('${lessonIdsInGroup}')">
                    Elimina Gruppo
                </button>
            `;
            listContainer.appendChild(groupHeader);
            
            // Ordina le lezioni all'interno del gruppo (per ora di creazione)
            lessonsInGroup.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            lessonsInGroup.forEach(data => {
                const key = data.id;
                const status = data.isLocked 
                    ? '<span class="text-red-600 font-medium">Archiviata</span>' 
                    : '<span class="text-green-600">In corso</span>';
                
                let scoreDisplay = '';
                if (data.isLocked && data.finalScore != null) {
                    scoreDisplay = `<span class="text-sm text-indigo-700 font-bold ml-2">(${data.finalScore}/500)</span>`;
                }
                    
                const itemEl = document.createElement('div');
                itemEl.className = 'saved-lesson-item';
                
                const creationTime = data.createdAt ? new Date(data.createdAt).toLocaleTimeString('it-IT', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : "N/D";
                
                itemEl.innerHTML = `
                    <div class="flex-grow min-w-0"> <!-- Container flessibile per nome -->
                        <div class="flex items-center">
                            <a href="#" class="font-medium text-blue-600 hover:underline truncate" onclick="openLesson('${key}'); return false;" title="${data.studentName}">
                                ${data.studentName}
                            </a>
                            ${scoreDisplay}
                        </div>
                        <span class="text-sm text-gray-500">${creationTime} - (${status})</span>
                    </div>
                    <button class="delete-btn ml-2" title="Elimina" onclick="deleteLesson('${key}')">&times;</button>
                `;
                listContainer.appendChild(itemEl);
            });
        });
    }

    function deleteLesson(lessonId) {
        if (confirm("Sei sicuro di voler eliminare questa valutazione? L'azione √® irreversibile.")) {
            localStorage.removeItem(lessonId);
            loadSavedLessonsList(); // Ricarica la lista dopo l'eliminazione
        }
    }
    
    // Funzione per eliminare un intero gruppo di lezioni
    function deleteLessonsByGroup(lessonIdsString) {
        const lessonIds = lessonIdsString.split(',');
        if (confirm(`Sei sicuro di voler eliminare tutte le ${lessonIds.length} valutazioni di questo gruppo? L'azione √® irreversibile.`)) {
            lessonIds.forEach(id => {
                localStorage.removeItem(id);
            });
            loadSavedLessonsList();
        }
    }
    
    // Funzione per eliminare TUTTI i dati
    function deleteAllData() {
        if (confirm("ATTENZIONE!\nStai per eliminare TUTTE le valutazioni salvate su questo dispositivo.\n\nAssicurati di aver esportato un backup se vuoi conservare i dati.\n\nVuoi continuare?")) {
            localStorage.clear();
            loadSavedLessonsList();
            document.getElementById('import-status').textContent = "Tutti i dati sono stati resettati.";
            document.getElementById('import-status').className = "text-sm mt-3 text-green-600";
        } else {
            document.getElementById('import-status').textContent = "Reset annullato.";
            document.getElementById('import-status').className = "text-sm mt-3 text-gray-600";
        }
    }


    function openLesson(lessonId) {
        showCalculatorPage(lessonId);
    }

    function loadLesson(lessonId) {
        currentLessonId = lessonId;
        
        const dataString = localStorage.getItem(lessonId);
        if (!dataString) {
            // Errore: Dati non trovati
            showHomeView();
            return;
        }
        
        const lessonData = JSON.parse(dataString);
        quickScores = lessonData.quickScores || {};
        
        // Popola i campi
        document.getElementById('student-name-display').textContent = lessonData.studentName;
        document.getElementById('lesson-notes').value = lessonData.notes || "";
        
        // Carica il modulo salvato
        const modulo = lessonData.moduloSvolto || "nessuno";
        const radioToCheck = document.querySelector(`input[name="modulo_obbligatorio"][value="${modulo}"]`);
        if (radioToCheck) {
            radioToCheck.checked = true;
        } else {
            document.getElementById('modulo_nessuno').checked = true;
        }
        
        // Renderizza i criteri e i calcoli
        renderQuickCriteria(quickScores);
        
        const scores = calculateScores(quickScores);
        renderDetailedSummary(scores.calculatedScores);
        renderCompetencyAreas(scores.competencyAreas_0_50, scores.competencyAreas_0_5, scores.totalScore_0_500);
        
        // Calcola e renderizza la previsione d'esame
        const examPredictions = calculateExamPredictionFromDetailed(scores.calculatedScores);
        renderExamPredictions(examPredictions);

        // Gestione conferma RIMOSSA
        
        // Gestisci lo stato bloccato
        if (lessonData.isLocked) {
            lockPage();
        } else {
            unlockPage();
        }
    }

    /**
     * Salva i dati temporaneamente (su input) senza bloccare.
     */
    function saveLessonData(isLocking = false) {
        if (!currentLessonId) return;
        
        if (isLocking) return; // Il salvataggio bloccato √® gestito da saveAndLockLesson

        const currentDataString = localStorage.getItem(currentLessonId);
        if (!currentDataString) return;
        
        const lessonData = JSON.parse(currentDataString);
        if (lessonData.isLocked) return; 
        
        lessonData.notes = document.getElementById('lesson-notes').value;
        lessonData.quickScores = quickScores;
        
        const selectedModulo = document.querySelector('input[name="modulo_obbligatorio"]:checked')?.value || "nessuno";
        lessonData.moduloSvolto = selectedModulo;
        
        localStorage.setItem(currentLessonId, JSON.stringify(lessonData));
    }
    
    /**
     * Funzione dedicata per il salvataggio finale (Blocco)
     * Senza conferma
     */
    function saveAndLockLesson() {
        // Controlli conferma RIMOSSI
        
        if (!currentLessonId) return;
        const currentDataString = localStorage.getItem(currentLessonId);
        if (!currentDataString) return;
        const lessonData = JSON.parse(currentDataString);
        if (lessonData.isLocked) return;

        if (confirm("Sei sicuro di voler salvare e archiviare questa valutazione? Non potrai pi√π modificarla.")) {
            
            // Salva tutti i dati (slider, note, moduli)
            lessonData.notes = document.getElementById('lesson-notes').value;
            lessonData.quickScores = quickScores;
            const selectedModulo = document.querySelector('input[name="modulo_obbligatorio"]:checked')?.value || "nessuno";
            lessonData.moduloSvolto = selectedModulo;

            // Calcola e salva il punteggio finale
            const { totalScore_0_500 } = calculateScores(lessonData.quickScores);
            lessonData.finalScore = totalScore_0_500;
            
            // Salva i dati di conferma RIMOSSI
            
            lessonData.isLocked = true;
            localStorage.setItem(currentLessonId, JSON.stringify(lessonData));
            lockPage();
        }
    }
    
    // Torna alla lista
    function goBackToList() {
        showHomeView();
    }
    
    function lockPage() {
        document.getElementById('lock-status').innerHTML = 'Stato: <span class="text-red-600 font-medium">Archiviata (Sola lettura)</span>';
        document.getElementById('lock-lesson-btn').disabled = true;
        document.getElementById('lesson-notes').disabled = true;
        
        document.querySelectorAll('.score-slider').forEach(slider => {
            slider.disabled = true;
        });
        document.querySelectorAll('input[name="modulo_obbligatorio"]').forEach(radio => {
            radio.disabled = true;
        });
        
        // Nascondi i campi di input della conferma
        document.getElementById('confirmation-container').classList.add('hidden');
        document.getElementById('confirmation-display').classList.add('hidden');
    }
    
    function unlockPage() {
        document.getElementById('lock-status').innerHTML = 'Stato: <span class="text-green-600">In corso...</span>';
        document.getElementById('lock-lesson-btn').disabled = false;
        document.getElementById('lesson-notes').disabled = false;
        
        document.querySelectorAll('.score-slider').forEach(slider => {
            slider.disabled = false;
        });
        document.querySelectorAll('input[name="modulo_obbligatorio"]').forEach(radio => {
            radio.disabled = false;
        });
        
        // Mostra i campi di conferma e resetta lo stato
        document.getElementById('confirmation-container').classList.remove('hidden');
        document.getElementById('confirmation-display').classList.add('hidden');
        document.getElementById('lock-lesson-btn').disabled = false; // Ri-abilitato
    }

    // --- FUNZIONI DI RENDERIZZAZIONE UI ---

    function renderQuickCriteria(scores) {
        const container = document.getElementById('quick-criteria-container');
        container.innerHTML = QUICK_CRITERIA.map((criterion, index) => {
            const value = scores[criterion] != null ? scores[criterion] : 5; // Default a 5 se non presente
            const description = SCORE_10_INTERPRETATION[value]; // Ottieni la descrizione
            return `
            <div class="space-y-1 p-3 bg-gray-50 rounded-lg shadow-inner">
                <label for="quick-slider-${index}" class="block text-sm font-semibold text-gray-700">${index + 1}. ${criterion}</label>
                
                <!-- Testo descrizione nascosto -->
                <p id="quick-desc-${index}" class="text-xs h-8 text-gray-500 overflow-hidden hidden">${description}</p>
                
                <div class="flex items-center space-x-3">
                    <!-- Emoji con eventi mousedown/touchstart per il tooltip personalizzato -->
                    <span id="quick-value-${index}" 
                          class="text-4xl w-12 text-center cursor-default" 
                          onmousedown="showTooltip(event, ${index})"
                          onmouseup="hideTooltip()"
                          ontouchstart="showTooltip(event, ${index})"
                          ontouchend="hideTooltip()"
                          oncontextmenu="event.preventDefault();" 
                          >
                          ${EMOJI_INTERPRETATION[value]}
                    </span>
                    <input type="range" min="0" max="10" value="${value}" id="quick-slider-${index}" data-name="${criterion}" data-index="${index}" class="score-slider flex-grow" oninput="updateQuickScore(event)" onchange="saveLessonData(false)">
                </div>
            </div>
        `}).join('');
    }

    // Chiamato quando uno slider 0-10 viene mosso
    function updateQuickScore(event) {
        if (event.target.tagName !== 'INPUT' || event.target.type !== 'range') return;
        
        const slider = event.target;
        const name = slider.getAttribute('data-name');
        const index = slider.getAttribute('data-index');
        const value = parseInt(slider.value, 10);
        
        const description = SCORE_10_INTERPRETATION[value];
        const emojiEl = document.getElementById(`quick-value-${index}`);
        
        emojiEl.textContent = EMOJI_INTERPRETATION[value];
        document.getElementById(`quick-desc-${index}`).textContent = description;
        
        quickScores[name] = value;

        const { calculatedScores, competencyAreas_0_50, competencyAreas_0_5, totalScore_0_500 } = calculateScores(quickScores);
        renderDetailedSummary(calculatedScores);
        renderCompetencyAreas(competencyAreas_0_50, competencyAreas_0_5, totalScore_0_500);
        
        // Aggiorna la previsione d'esame
        const examPredictions = calculateExamPredictionFromDetailed(calculatedScores);
        renderExamPredictions(examPredictions);
    }

    function renderDetailedSummary(detailedScores) {
        const container = document.getElementById('calculated-scores-container');
        let html = '';

        COMPETENCY_AREAS.forEach((area) => {
            html += `
                <div class="mt-4 mb-3 col-span-full border-b pb-1">
                    <h3 class="text-base font-semibold text-gray-800">${area.name}</h3>
                </div>
            `;
            
            html += `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 col-span-full">`;
            
            area.criteria.forEach(criterionIndex => {
                const criterion = DETAILED_CRITERIA[criterionIndex];
                const score = detailedScores[criterion] || 0;
                const interpretation = SCORE_5_INTERPRETATION[score] || SCORE_5_INTERPRETATION[0];

                html += `
                    <div class="grid grid-cols-[1fr_auto] items-center gap-2 text-sm">
                        <span class="text-gray-700 truncate" title="${criterion}">${criterion}</span>
                        <span class="flex items-center justify-center w-6 h-6 font-bold rounded-full text-xs ${interpretation.color}">
                            ${score}
                        </span>
                    </div>
                `;
            });

            html += `</div>`;
        });
        
        container.innerHTML = html;
    }

    /**
     * Accetta i punteggi 0-50 (per i colori) e 0-5 (per la visualizzazione)
     */
    function renderCompetencyAreas(competencyAreas_0_50, competencyAreas_0_5, totalScore) {
        const container = document.getElementById('competency-summary');
        
        container.innerHTML = COMPETENCY_AREAS.map(area => {
            const score_0_50 = competencyAreas_0_50[area.name] || 0;
            const score_0_5 = competencyAreas_0_5[area.name] || 0;
            
            let color;
            if (score_0_5 >= 3) {
                color = 'bg-green-200 text-green-800'; // Verde
            } else if (score_0_5 >= 2) {
                color = 'bg-yellow-200 text-yellow-800'; // Giallo
            } else {
                color = 'bg-red-200 text-red-800'; // Rosso
            }

            return `
                <div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 bg-white shadow-sm">
                    <span class="font-medium text-gray-700">${area.name}</span>
                    <span class="flex items-center justify-center w-8 h-8 text-sm font-bold rounded-full ${color}">
                        ${score_0_5}
                    </span>
                </div>
            `;
        }).join('');

        document.getElementById('total-score-500').textContent = `${totalScore} / 500`;
    }
    
    /**
     * Renderizza la sezione Previsione Esame (Grattabili)
     */
    function renderExamPredictions(predictions) {
        const container = document.getElementById('exam-items-container');
        container.innerHTML = ''; // Pulisce
        
        // Itera sulla lista dei criteri d'esame
        for (const [key, text] of Object.entries(EXAM_CRITERIA)) {
            const result = predictions[key] || "NO"; // 'NO' di default
            const resultClass = result === "SI" ? "si" : "no";
            
            const itemHtml = `
                <div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 bg-white shadow-sm">
                    <span class="font-medium text-gray-700">${key}) ${text}</span>
                    <div class="scratch-container">
                        <div id="result-${key}" class="scratch-result ${resultClass}">${result}</div>
                        <div id="cover-${key}" class="scratch-cover" onclick="reveal('${key}')">GRATTA QUI</div>
                    </div>
                </div>
            `;
            container.innerHTML += itemHtml;
        }
    }
    
    // Funzione per rivelare il "Grattabile"
    function reveal(key) {
        const cover = document.getElementById(`cover-${key}`);
        if (cover) {
            cover.style.opacity = '0';
            // Rimuovi dopo l'animazione per non bloccare il testo
            setTimeout(() => { cover.classList.add('hidden'); }, 300);
        }
    }


    // --- Funzioni Tooltip Personalizzate ---
    function showTooltip(event, index) {
        event.preventDefault(); 
        
        const slider = document.getElementById(`quick-slider-${index}`);
        if (!slider) return;
        const value = slider.value;
        
        const text = SCORE_10_INTERPRETATION[value];
        
        tooltip.textContent = text;
        tooltip.classList.remove('hidden');

        const x = event.touches ? event.touches[0].pageX : event.pageX;
        const y = event.touches ? event.touches[0].pageY : event.pageY;

        tooltip.style.left = (x + 15) + 'px'; 
        tooltip.style.top = (y + 15) + 'px'; 
    }

    function hideTooltip() {
        tooltip.classList.add('hidden');
    }
    
    // --- Funzioni Import/Export ---
    
    function exportData() {
        const statusEl = document.getElementById('import-status');
        let exportObj = null;

        try {
            exportObj = {
                appName: "RegistroValutazioniGuida",
                exportDate: new Date().toISOString(),
                lessons: []
            };
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('lesson_')) {
                    const lesson = JSON.parse(localStorage.getItem(key));
                    
                    // MODIFICA: Ricalcola il punteggio totale al volo per tutte le lezioni
                    // per assicurarsi che "calculatedTotalScore" sia presente anche se la lezione non √® chiusa.
                    const { totalScore_0_500 } = calculateScores(lesson.quickScores || {});
                    lesson.calculatedTotalScore = totalScore_0_500;
                    
                    exportObj.lessons.push(lesson);
                }
            }
            
            if (exportObj.lessons.length === 0) {
                 statusEl.textContent = "Nessun dato da esportare.";
                 statusEl.className = "text-sm mt-3 text-yellow-600";
                 return;
            }

            // --- 1. DOWNLOAD LOCALE (CORRETTO PER MOBILE E IPAD) ---
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.href = url;
            const date = new Date().toISOString().split('T')[0];
            downloadAnchorNode.download = `backup_registro_valutazioni_${date}.json`;
            
            // Aggiunta per compatibilit√† iPad/iOS
            downloadAnchorNode.target = "_blank"; 
            
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            
            // Aumentato il timeout per permettere a iPad di elaborare il click
            setTimeout(() => {
                document.body.removeChild(downloadAnchorNode);
                window.URL.revokeObjectURL(url);
            }, 3000); 
            
            statusEl.textContent = `Scaricato backup locale (${exportObj.lessons.length} lezioni). Invio a Drive in corso...`;
            statusEl.className = "text-sm mt-3 text-blue-600";

            // --- 2. INVIO A GOOGLE APPS SCRIPT (CORRETTO PER MOBILE/CORS/IPAD) ---
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                credentials: 'omit', // MODIFICA IMPORTANTE: Evita invio cookie che Safari blocca
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8' 
                },
                body: JSON.stringify(exportObj)
            })
            .then(response => {
                statusEl.textContent = `Backup scaricato e inviato a Google Drive (Invio confermato).`;
                statusEl.className = "text-sm mt-3 text-green-600 font-bold";
            })
            .catch(error => {
                console.error("Errore Drive:", error);
                statusEl.textContent = `Backup scaricato, ma invio a Drive fallito (controlla connessione o impostazioni privacy Safari).`;
                statusEl.className = "text-sm mt-3 text-red-600";
            });

        } catch (error) {
            console.error("Errore durante l'esportazione:", error);
            statusEl.textContent = `Errore durante l'esportazione: ${error.message}`;
            statusEl.className = "text-sm mt-3 text-red-600";
        }
    }
    
    function importData(event) {
        const file = event.target.files[0];
        const statusEl = document.getElementById('import-status');
        
        if (!file) {
            statusEl.textContent = "Nessun file selezionato.";
            statusEl.className = "text-sm mt-3 text-yellow-600";
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!data || data.appName !== "RegistroValutazioniGuida" || !Array.isArray(data.lessons)) {
                    throw new Error("File non valido o formato non corretto.");
                }
                
                if (confirm(`Attenzione! Stai per importare ${data.lessons.length} valutazioni. Questo SOVRASCRIVER√Ä tutti i dati attualmente salvati. Continuare?`)) {
                    localStorage.clear();
                    
                    data.lessons.forEach(lesson => {
                        // Assicura che i dati importati siano validi
                        if (lesson.id && lesson.studentName) {
                            localStorage.setItem(lesson.id, JSON.stringify(lesson));
                        }
                    });
                    
                    statusEl.textContent = `Importate ${data.lessons.length} valutazioni con successo.`;
                    statusEl.className = "text-sm mt-3 text-green-600";
                    loadSavedLessonsList(); // Aggiorna la lista
                } else {
                    statusEl.textContent = "Importazione annullata.";
                    statusEl.className = "text-sm mt-3 text-gray-600";
                }

            } catch (error) {
                console.error("Errore durante l'importazione:", error);
                statusEl.textContent = `Errore durante l'importazione: ${error.message}`;
                statusEl.className = "text-sm mt-3 text-red-600";
            } finally {
                // Resetta l'input file per permettere di ricaricare lo stesso file
                event.target.value = null;
            }
        };
        
        reader.readAsText(file);
    }

    // Esponi le funzioni necessarie all'ambito globale per gli onclick HTML
    window.updateQuickScore = updateQuickScore;
    window.startNewLesson = startNewLesson;
    window.loadSavedLessonsList = loadSavedLessonsList;
    window.deleteLesson = deleteLesson;
    window.deleteLessonsByGroup = deleteLessonsByGroup;
    window.deleteAllData = deleteAllData;
    window.saveLessonData = saveLessonData;
    window.saveAndLockLesson = saveAndLockLesson;
    window.goBackToList = goBackToList;
    window.openLesson = openLesson;
    window.showTooltip = showTooltip;
    window.hideTooltip = hideTooltip;
    window.exportData = exportData;
    window.importData = importData;
    window.reveal = reveal; // Esponi la funzione Grattabile
    
    // Avvia l'applicazione
    initPage();

</script>
</body>
</html>
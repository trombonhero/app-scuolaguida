<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Valutazioni Guida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7ff; 
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            margin-bottom: 1.5rem;
        }
        .score-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #e5e7eb; 
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 5px;
            touch-action: none;
        }
        .score-slider:hover { opacity: 1; }
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        .score-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007bff;
            cursor: pointer;
            border-radius: 50%;
        }
        
        /* FIX TABLET */
        input[type="text"], textarea, select, input[type="date"] {
             touch-action: manipulation;
        }
        
        /* Stili Pulsanti */
        .btn {
            font-weight: 600;
            padding: 0.75rem 1.5rem; 
            border-radius: 0.75rem; 
            transition: all 0.2s;
            text-align: center;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0069d9; }
        
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }

        .btn-outline { background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
        .btn-outline:hover { background-color: #e9ecef; }

        .btn:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        
        /* Stili Liste */
        .saved-lesson-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .saved-lesson-item:last-child { border-bottom: none; }
        
        .date-group-header {
            font-size: 1.125rem; font-weight: 600; color: #1f2937;
            margin-top: 1.25rem; margin-bottom: 0.5rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb; display: flex;
            justify-content: space-between; align-items: center;
        }
        .date-group-header:first-child { margin-top: 0; }
        
        .delete-btn {
            background-color: #fef2f2; color: #ef4444; font-weight: bold;
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #fecaca; line-height: 1; flex-shrink: 0;
        }
        .delete-btn:hover { background-color: #fee2e2; }

        .delete-group-btn {
            background-color: #fef2f2; color: #ef4444; font-size: 0.75rem;
            font-weight: 600; border-radius: 0.5rem; padding: 0.25rem 0.75rem;
            border: 1px solid #fecaca;
        }
        .delete-group-btn:hover { background-color: #fee2e2; }
        
        #import-file-input { display: none; }

        /* Accordion */
        details summary {
            list-style: none; cursor: pointer; font-size: 1.25rem; font-weight: 700;
            color: #374151; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb;
            display: flex; justify-content: space-between; align-items: center;
        }
        details summary::after { content: '‚ñº'; font-size: 0.7rem; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }
        details summary::-webkit-details-marker { display: none; }
        details > div { padding-top: 1.5rem; }

        /* Gratta e Vinci */
        .scratch-container {
            position: relative; width: 80px; height: 40px;
            border-radius: 0.5rem; overflow: hidden; border: 1px solid #d1d5db;
        }
        .scratch-result {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.125rem;
        }
        .scratch-result.si { color: #16a34a; }
        .scratch-result.no { color: #dc2626; }
        
        .scratch-cover {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #c0c0c0;
            background-image: linear-gradient(45deg, #d1d5db 25%, transparent 25%, transparent 75%, #d1d5db 75%, #d1d5db), 
                              linear-gradient(-45deg, #d1d5db 25%, transparent 25%, transparent 75%, #d1d5db 75%, #d1d5db);
            background-size: 6px 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; font-weight: 600; color: #4b5563;
            cursor: pointer; transition: opacity 0.3s;
        }
        
        .radio-filter:checked + label {
            background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; font-weight: 700;
        }
        
        /* Toast Notification */
        #toast-notification {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            background-color: #10b981; color: white; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; font-weight: 600; transition: opacity 0.3s, transform 0.3s;
            opacity: 0; pointer-events: none;
        }
        #toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Search Suggestions */
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .suggestion-item:hover {
            background-color: #eff6ff;
        }
        .suggestion-highlight {
            font-weight: bold;
            color: #2563eb;
        }

        /* --- NUOVI COLORI PUNTEGGI --- */
        .bg-score-0 { background-color: #9E9E9E; color: white; } /* Grigio */
        .bg-score-1 { background-color: #EA3D33; color: white; } /* Rosso */
        .bg-score-2 { background-color: #FE9F10; color: white; } /* Arancione */
        .bg-score-3 { background-color: #94C655; color: white; } /* Verde Chiaro (Lime) */
        .bg-score-4 { background-color: #49A04B; color: white; } /* Verde Medio */
        .bg-score-5 { background-color: #38843D; color: white; } /* Verde Scuro */

    </style>
</head>
<body>

<!-- Notifica Toast -->
<div id="toast-notification">Valutazione Salvata con successo!</div>

<div id="custom-tooltip" class="hidden absolute z-50 p-2 bg-gray-800 text-white text-sm rounded-lg shadow-lg max-w-xs" style="pointer-events: none; transition: opacity 0.1s ease;"></div>

<!-- PAGINA AVVIO -->
<div id="home-view" class="container">
    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-6 text-center">Registro Valutazioni Guida</h1>
    
    <div class="card relative">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Crea Nuova Valutazione</h2>
        
        <!-- GLOBAL SEARCH -->
        <div class="mb-6 relative">
            <label class="block text-sm font-bold text-gray-800 mb-1">üîç Cerca Allievo (Compilazione Automatica)</label>
            <input type="text" id="global-student-search" placeholder="Inizia a scrivere nome o cognome..." 
                   class="w-full p-3 border-2 border-blue-100 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-blue-50"
                   oninput="handleGlobalSearch(this.value)">
            <div id="search-results" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto mt-1">
                <!-- Results go here -->
            </div>
        </div>
        
        <div class="space-y-4">
            <!-- Riga 1: Sede e Patente -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sede</label>
                    <!-- FIX: toggleEditLocationInput(true) per focus esplicito utente -->
                    <select id="location-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateLicenseOptions(); toggleLocationInput(true)">
                        <option value="">Seleziona Sede...</option>
                        <!-- Options filled by JS -->
                    </select>
                    <input type="text" id="location-input-manual" placeholder="Scrivi sede..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-2 hidden">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo Patente</label>
                    <!-- FIX: Inverted order to ensure focus happens AFTER update options -->
                    <select id="license-type-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="updateStudentOptions(); toggleLicenseInput(true);" disabled>
                        <option value="">Prima seleziona Sede</option>
                    </select>
                    <input type="text" id="license-input-manual" placeholder="Scrivi patente..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-2 hidden">
                </div>
            </div>

            <!-- Riga 2: Nome Allievo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nome Allievo/a</label>
                <div class="relative">
                    <!-- FIX: checkManualStudentInput(true) per focus esplicito utente -->
                    <select id="student-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="checkManualStudentInput(true)" disabled>
                        <option value="">Prima seleziona Patente</option>
                    </select>
                </div>
                <!-- FIX: Visible manually if set programmatically via search -->
                <input type="text" id="student-name-manual" placeholder="Scrivi nome manualmente..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-2 hidden">
            </div>

            <!-- Riga 3: Data e Durata -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Lezione</label>
                    <input type="date" id="lesson-date-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Durata Guida</label>
                    <select id="duration-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="30">30 Minuti</option>
                        <option value="60" selected>60 Minuti</option>
                        <option value="120">120 Minuti</option>
                    </select>
                </div>
            </div>

            <button id="start-lesson-btn" onclick="startNewLesson()" class="btn btn-primary w-full mt-4">Inizia Valutazione</button>
        </div>
        <p id="landing-error" class="text-red-600 text-sm mt-3 hidden text-center"></p>
    </div>
    
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-green-700">Valutazioni Salvate (Da Esportare)</h2>
        <div id="saved-lessons-list" class="space-y-2"></div>
    </div>

    <div class="card bg-gray-50 border border-gray-200">
        <details>
            <summary class="text-gray-600 font-semibold">Valutazioni Archiviate (Esportate)</summary>
            <div id="archived-lessons-list" class="space-y-2 mt-4"><p class="text-gray-400 italic text-sm">Nessuna valutazione in archivio.</p></div>
        </details>
    </div>
    
    <div class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Export e Dati</h2>
        <p class="text-sm text-gray-600 mb-4">Esporta i dati attuali. <strong>Nota:</strong> Le valutazioni verranno spostate in "Archivio" SOLO se sei online.</p>
        <div class="grid grid-cols-2 gap-4">
            <button id="export-btn" class="btn btn-primary">Esporta Dati</button>
            <input type="file" id="import-file-input" accept=".json" onchange="importData(event)">
            <button id="import-btn" class="btn btn-outline">Importa Dati</button>
            <button id="reset-all-btn" onclick="deleteAllData()" class="btn btn-danger col-span-2">Resetta Tutti i Dati (App)</button>
        </div>
        <p id="import-status" class="text-sm mt-3"></p>
    </div>
</div>

<!-- PAGINA CALCOLATORE -->
<div id="calculator-page" class="container hidden">
    <!-- SEZIONE GESTIONE -->
    <div id="management-section" class="card">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="w-full">
                <label class="text-xs text-gray-500 font-bold uppercase">Nome Allievo</label>
                <input type="text" id="student-name-edit" class="text-xl sm:text-2xl font-bold text-blue-600 bg-transparent border-b border-gray-300 focus:border-blue-500 focus:outline-none w-full mb-3" oninput="updateStudentName(this.value)">
                
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 bg-gray-50 p-2 rounded-lg border border-gray-100 mb-2">
                     <!-- NUOVO: DATA EDITABILE -->
                    <div class="flex flex-col">
                        <label class="text-[10px] uppercase font-bold text-gray-400">Data</label>
                        <input type="date" id="edit-lesson-date" class="bg-transparent font-semibold focus:outline-none w-full" onchange="updateLessonDetails()">
                    </div>
                    <!-- Patente -->
                    <div class="flex flex-col border-l border-gray-200 pl-2">
                        <label class="text-[10px] uppercase font-bold text-gray-400">Patente</label>
                        <input type="text" id="edit-license-type" class="bg-transparent font-semibold focus:outline-none border-b border-transparent focus:border-blue-400 w-full" oninput="updateLessonDetails()">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 bg-gray-50 p-2 rounded-lg border border-gray-100">
                    <!-- Durata -->
                    <div class="flex flex-col">
                        <label class="text-[10px] uppercase font-bold text-gray-400">Durata</label>
                        <select id="edit-duration" class="bg-transparent font-semibold focus:outline-none w-full" onchange="updateLessonDetails()">
                            <option value="30">30 min</option>
                            <option value="60">60 min</option>
                            <option value="120">120 min</option>
                        </select>
                    </div>
                    <!-- Sede -->
                    <div class="flex flex-col border-l border-gray-200 pl-2 relative">
                        <label class="text-[10px] uppercase font-bold text-gray-400">Sede</label>
                        <select id="edit-location-select" class="bg-transparent font-semibold focus:outline-none w-full" onchange="toggleEditLocationInput(); updateLessonDetails()">
                             <option value="other">Altro...</option>
                        </select>
                        <input type="text" id="edit-location-manual" placeholder="Scrivi sede..." class="hidden absolute top-0 left-0 w-full h-full bg-white border border-blue-300 rounded px-1 z-10" onblur="updateLessonDetails()">
                        <button id="close-manual-loc" class="hidden absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-4 h-4 flex items-center justify-center text-xs z-20" onclick="resetEditLocation()">x</button>
                    </div>
                </div>

                <p id="lock-status" class="text-sm font-medium text-gray-500 mt-2">Stato: <span class="text-green-600">In corso...</span></p>
            </div>
        </div>
    </div>

    <!-- VALUTAZIONE RAPIDA -->
    <div id="valuation-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Valutazione Guida</h2>
        
        <div class="mb-6 overflow-x-auto">
            <label class="block text-sm font-bold text-gray-700 mb-2">Seleziona Tipo Scheda:</label>
            <div class="flex space-x-2 min-w-max pb-2">
                <div><input type="radio" id="filter-b" name="card-filter" value="B" class="radio-filter hidden" onchange="updateCardFilter('B')"><label for="filter-b" class="cursor-pointer px-3 py-2 border rounded-lg text-sm text-gray-600 bg-white hover:bg-gray-50 border-gray-200 transition-colors">Scheda B</label></div>
                <div><input type="radio" id="filter-moto" name="card-filter" value="Moto" class="radio-filter hidden" onchange="updateCardFilter('Moto')"><label for="filter-moto" class="cursor-pointer px-3 py-2 border rounded-lg text-sm text-gray-600 bg-white hover:bg-gray-50 border-gray-200 transition-colors">Moto A1/A2/A</label></div>
                <div><input type="radio" id="filter-amquad" name="card-filter" value="AmQuad" class="radio-filter hidden" onchange="updateCardFilter('AmQuad')"><label for="filter-amquad" class="cursor-pointer px-3 py-2 border rounded-lg text-sm text-gray-600 bg-white hover:bg-gray-50 border-gray-200 transition-colors">AM Quad, B1</label></div>
                <div><input type="radio" id="filter-amciclo" name="card-filter" value="AmCiclo" class="radio-filter hidden" onchange="updateCardFilter('AmCiclo')"><label for="filter-amciclo" class="cursor-pointer px-3 py-2 border rounded-lg text-sm text-gray-600 bg-white hover:bg-gray-50 border-gray-200 transition-colors">AM Ciclo</label></div>
                <div><input type="radio" id="filter-superiori" name="card-filter" value="Superiori" class="radio-filter hidden" onchange="updateCardFilter('Superiori')"><label for="filter-superiori" class="cursor-pointer px-3 py-2 border rounded-lg text-sm text-gray-600 bg-white hover:bg-gray-50 border-gray-200 transition-colors">Superiori BE/C/D</label></div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <p class="text-sm text-gray-600">Assegna una valutazione. La descrizione di supporto appare tenendo premuta l'emoticon.</p>
            <!-- Pulsante toggle emoji visibile SOLO se non siamo in Superiori -->
            <button id="emoji-toggle-btn" onclick="toggleEmojiMode()" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded-full shadow-sm hover:bg-gray-50 font-semibold text-blue-600 transition-colors">
                Cambia stile: <span id="toggle-icon-display">üî¢</span>
            </button>
        </div>
        
        <!-- Master Slider nascosto per Superiori -->
        <div id="master-slider-container" class="mb-8 p-4 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm">
            <label for="master-slider" class="block text-sm font-bold text-indigo-900 mb-2">‚ö° Valutazione Rapida Totale (Imposta tutti)</label>
            <div class="flex items-center space-x-3">
                <span id="master-value-display" class="text-2xl w-10 text-center font-bold">üßê</span>
                <input type="range" min="0" max="10" value="5" id="master-slider" class="score-slider flex-grow cursor-pointer" oninput="updateMasterScore(event)">
            </div>
        </div>

        <div id="quick-criteria-container" class="grid lg:grid-cols-3 md:grid-cols-2 gap-x-8 gap-y-6"></div>

        <!-- MODULI OBBLIGATORI (HIDDEN ON NON-B) -->
        <div id="mandatory-modules-section" class="mt-8">
            <label class="block text-sm font-medium text-gray-700 mb-3">Moduli Obbligatori Svolti:</label>
            <div id="moduli-container" class="space-y-3">
                <div><input type="radio" id="modulo_nessuno" name="modulo_obbligatorio" value="nessuno" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)" checked><label for="modulo_nessuno" class="ml-2 text-sm font-medium text-gray-900">Nessuno</label></div>
                <div><input type="radio" id="modulo_a" name="modulo_obbligatorio" value="A" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)"><label for="modulo_a" class="ml-2 text-sm font-medium text-gray-900">Modulo A - La guida in condizioni di visione notturna, Circolazione su strade urbane strette e larghe, con veicoli parcheggiati ai lati e non, affrontando incroci regolati da segnaletica verticale e da impianti semaforici.</label></div>
                <div><input type="radio" id="modulo_b" name="modulo_obbligatorio" value="B" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)"><label for="modulo_b" class="ml-2 text-sm font-medium text-gray-900">Modulo B - Guida su strade extraurbane, Circolazione su strade urbane di scorrimento, o su strade extraurbane secondarie, utilizzando il veicolo ed il motore a regime di copia massima consumando e inquinando il minimo possibile.</label></div>
                <div><input type="radio" id="modulo_c" name="modulo_obbligatorio" value="C" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" onchange="saveLessonData(false)"><label for="modulo_c" class="ml-2 text-sm font-medium text-gray-900">Modulo C - Guida su autostrade o su strade extraurbane, Circolazione su autostrade o su strade extraurbane principali o su strade extraurbane secondarie superando la velocit√† di 50 Km/h, utilizzando la 5^ marcia e adeguando le marce alla velocit√†.</label></div>
            </div>
        </div>
        
        <div class="mt-8">
            <label for="lesson-notes" class="block text-sm font-medium text-gray-700 mb-2">Note della Lezione (Opzionale):</label>
            <textarea id="lesson-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="saveLessonData(false)"></textarea>
        </div>
    </div>

    <!-- PUNTEGGIO TOTALE -->
    <div id="total-score-section" class="card">
        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg flex justify-between items-center">
            <span class="text-lg font-bold text-indigo-800">Punteggio Totale Calcolato:</span>
            <div class="scratch-container" style="width: 160px; height: 50px; border-radius: 0.5rem;">
                <div id="result-total-score" class="scratch-result"><span id="total-score-500" class="text-2xl font-extrabold text-indigo-800">0 / 500</span></div>
                <div id="cover-total-score" class="scratch-cover" onclick="reveal('total-score')" style="border-radius: 0.5rem; font-size: 0.875rem;">GRATTA QUI</div>
            </div>
        </div>
    </div>

    <!-- RIEPILOGO AREE -->
    <div id="competency-section-wrapper" class="card">
        <details>
            <summary>3. Riepilogo Aree di Competenza</summary>
            <div id="competency-summary" class="grid md:grid-cols-2 gap-4"></div>
        </details>
    </div>

    <!-- RIEPILOGO DETTAGLIATO -->
    <div id="detailed-summary-section-wrapper" class="card">
        <details>
            <summary>4. Riepilogo Dettagliato</summary>
            <div id="calculated-scores-container"></div>
        </details>
    </div>
    
    <!-- PATENTOMETRO -->
    <div id="exam-prediction-section" class="card">
        <details>
            <summary>5. Patentometro</summary>
            <div>
                <p class="text-sm text-gray-600 mb-6">Clicca o "gratta" il riquadro argentato per rivelare il risultato.</p>
                <div id="exam-items-container" class="space-y-4"></div>
            </div>
        </details>
    </div>

    <!-- SALVA -->
    <div id="save-section" class="card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">6. Salva e Completa</h2>
        <div id="confirmation-container"><p class="text-sm text-gray-600 mb-4">Clicca "Salva" per archiviare la valutazione.</p></div>
        <div id="confirmation-display" class="hidden"></div>
        <div class="flex flex-col sm:flex-row gap-4 mt-6">
            <button id="lock-lesson-btn" onclick="saveAndLockLesson()" class="btn btn-danger flex-1">Salva</button>
            <button id="unlock-lesson-btn" onclick="unlockLesson()" class="btn btn-warning flex-1 hidden">Sblocca e Modifica</button>
            <button onclick="goBackToList()" class="btn btn-secondary flex-1">Indietro</button>
        </div>
    </div>
</div>

<script type="module">
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwkHbvXDiVAdRhNGVKIksKRpbBKRbnStac4keAUW39AqQ4nj_WaSR5WoK2AfMXuYoTg/exec";

    // --- DATABASE AGGIORNATO ---
    const DB_ALLIEVI = {
        "Colleferro": {
            "B": [
                "Alice Crecco", "Alisia Pelacci", "Andrea Russo", "Angelica Gabrieli", "Angelica Matturro", 
                "Angelica Mescia", "Anna Belli", "Arduini Edoardo", "Aurora Consilia Pecchi", "Aurora Gizzi", 
                "Aurora Sozzi", "Beatrice Uras", "Bran Elisa", "Campagna Valerio", "Carrubino Erica", 
                "Chiara Grieco", "Chima Samuele", "Collacchi Valerio", "Coluzzi Elena", "Cristal Turri", 
                "Cristian Dragutinovic", "Daniele Mazzocchi", "De Felice Lonardo", "Denise Gabrielli", 
                "Eleonora Santigli", "Fabrizio Ravelli", "Ferrante Martina", "Frattaroli Valeria", 
                "Gagliarducci Valerio", "Galesso Tommaso", "Gallo Noemi", "Giacomo Marcozzi", "Giada Vari", 
                "Giorgia Mastrogiacomo", "Grazia Greco Maria", "Gregory Pezzella", "Greta Turco", 
                "Iadarola Pietro", "Ilaria Ippoliti", "Ilaria Loreti", "Lavinia Proia", "Leo Veronica", 
                "Lorenza Necci", "Lorenzo Stella", "Marchetti Valentina", "Maria Martina Priori", 
                "Momodu Odidi", "Ricci Valerio", "Sara Tantari", "Selene Sortoluzzi"
            ],
            "B1": ["Damiano Falcone", "Greta Testa", "Syria Testa"],
            "BS": ["Carrubino Erica"],
            "GA": ["Francesco Padovani"]
        },
        "Di Castro": {
            "Am": ["Luca Silvestri"]
        },
        "Genazzano": {
            "B": [
                "Agnetelli Asia", "Alessio Luberti", "Alexandru Carp", "Amarilda Mataj", "Angelucci Lara", 
                "Asia Maggi", "Bangrazi Kevin", "Beatrice Canini", "Bianchi Daniele", "Chiara Ronci", 
                "Eleonora Poeta", "Escalona Laura Piedra", "Evelin Gentili", "Gabriel Nita", "Lazzara Martina", 
                "Massimiliano Rocca"
            ]
        },
        "La Maxima": {
            "A": ["Carlo Crescenzi", "Chiara Nicolia"]
        },
        "Palestrina": {
            "B": [
                "Bernardini Giulia", "Boscaini Elena", "Chiara Trentini", "Dell'Orco Simone", 
                "Romano Sara", "Ruggero Verrelli"
            ]
        },
        "Paliano": {
            "B": [
                "Alexander Porfilio", "Antonio Terenzi", "Aurora Sportoletti", "Clara Tiroli", 
                "Francesca Marucci", "Ippoliti Leonardo", "Lorenzo Verani", "Pacciani Virginia"
            ]
        },
        "Roma": {
            "B": ["Bokiniec Karol Piotr", "Ferrante Martina", "Ionelia Lazar"]
        }
    };

    let currentLessonId = null;
    let quickScores = {}; 
    let currentCardFilter = 'B'; 
    let showEmojis = true;
    let isEditingExistingLesson = false; 

    const tooltip = document.getElementById('custom-tooltip');
    const EMOJI_INTERPRETATION = { 0: "üò∂", 1: "üò±", 2: "üò®", 3: "üò£", 4: "ü§î", 5: "üßê", 6: "üôÇ", 7: "üòä", 8: "üòÑ", 9: "ü§©", 10: "üòé" };
    const SCORE_10_INTERPRETATION = {
        0: "Non ancora spiegato ‚Üí L'argomento o la manovra non √® stata ancora trattata.", 1: "Grave errore ‚Üí Tentativo fallito, comportamento inadeguato.",
        2: "Molto insicuro ‚Üí Errori gravi, necessit√† di intervento.", 3: "Insicuro ‚Üí Errori evidenti, esecuzione incerta.",
        4: "Migliorabile ‚Üí Errori non gravi, ma guida imprecisa.", 5: "Quasi sufficiente ‚Üí Autonomia parziale, migliorabile.",
        6: "Sufficiente ‚Üí Controllo adeguato, ma con margini di miglioramento.", 7: "Discreto ‚Üí Guida sicura con qualche imprecisione.",
        8: "Buono ‚Üí Buon controllo del veicolo e sicurezza elevata.", 9: "Distinto ‚Üí Guida fluida con anticipazione dei rischi.",
        10: "Ottimo ‚Üí Controllo totale, sicurezza massima."
    };

    const QUICK_CRITERIA = [
        "Sguardo", "Fluidit√† nel volante", "Accelerazione in partenza", "Modulazione della frenata", "Fluidit√† nel cambio", "Utilizzo della frizione", "Partenza in salita", "Posizione del veicolo su strada", "Svolta a destra", "Svolta a sinistra", "Comportamento negli incroci", "Punto morto", "Voltarsi nelle retromarce", "Inversione di marcia", "Parcheggi in retromarcia", "Accostare il veicolo", "Padronanza delle situazioni", "Postura di guida", "Regolazione e uso degli specchi retrovisori", "Uso e conoscenza dei dispositivi e teoria motore",
        "ES. 1 Curva", 
        "ES. 2 Parcheggio ed uscita in retro", 
        "ES. 3 Accel./Frenata emergenza", 
        "Partenza", 
        "Posizione della moto su strada", 
        "Girare la testa", 
        "ES. equilibrio", 
        "ES. equilibrio (Tempo)", 
        "ES. velocit√†", 
        "ES. velocit√† (Tempo)", 
        "Sistemazione prima della partenza", 
        "Manovra di accostamento in retromarcia", 
        "Parcheggio in retromarcia \"L\"", 
        "Parcheggio in retromarcia \"S\"", 
        "Accostare il veicolo (fermata)", 
        "Slalom", 
        "Otto", 
        "Passaggio stretto", 
        "Accelerazione e frenata",
        "Circolazione", // 39 (Nuovo)
        "Rotatorie", // 40 (Nuovo)
        "Esercizi", // 41 (Nuovo)
        "Retro L", // 42 (Nuovo)
        "Manovra L", // 43 (Nuovo)
        "Combinazione Freno Frizione", // 44 (Nuovo)
        "Controllo Punto Morto" // 45 (Nuovo)
    ];
    
    // Configurazione Indici (0-based)
    const CARD_CONFIGS = {
        'B': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        'Moto': [26, 27, 28, 29, 39, 9, 10, 40, 11], // 11 = Punto morto existing
        'AmCiclo': [41, 36, 39, 9, 10, 40, 11], 
        'AmQuad': [41, 42, 39, 9, 10, 40, 11], 
        'Superiori': [43, 13, 31, 44, 4, 7, 10] 
    };

    const DETAILED_CRITERIA = ["Regolazione sedile in distanza, altezza ed inclinazione", "Regolazione specchi, poggiatesta e cintura", "Posizione corretta delle mani", "Uso volante in curva aperta dx sx", "Uso volante in curva media dx sx", "Uso volante in curva stretta dx sx", "Uso volante in svolta dx sx", "Uso visione centrale e direzione del veicolo", "Uso visione periferica", "Dinamicit√† dello sguardo", "Capacit√† di anticipazione visiva", "Corretto utilizzo sguardo in curva a destra", "Corretto utilizzo sguardo in curva a sinistra", "Corretta sequenza rti (retrovisori, testa, indicatore)", "Sensibilit√† all'uso dell'acceleratore", "Sensibilit√† uso freno frenata degressiva", "Passaggio freno acceleratore ancoraggio tacco", "Frenata di precisione rispetto ad un punto d'arresto predeterminato", "Frenata in situazioni di pericolo", "Corretto utilizzo del piede sulla frizione", "Piede su passaruota con frizione a riposo", "Ricerca innesto frizione", "Tenuta pedale dopo innesto", "Combinazione gas frizione in partenza", "Partenza in pianura discesa", "Partenza in salita", "Impostazioni mano su cambio", "Incremento marce seconda e terza", "Decremento marce terza e seconda", "Sequenza completa incremento marce", "Sequenza completa scalata marce", "Preparazione cambiata anticipo mano", "Incremento marce con equilibrio volante", "Scalata tenuta freno e uso frizione", "Coordinazione motoria frizione cambio volante", "Svolta a sx su strada a doppio senso (posizione, esecuzione)", "Svolta a sx su strada a senso unico (posizione, esecuzione)", "Svolta a destra (posizione esecuzione)", "Comportamenti alle rotatorie", "Comportamento in preselezione di incrocio", "Rispetto della segnaletica agli incroci", "Capacit√† di adattamento al buio", "Comportamento nei confronti dei veicoli che provengono dalla direzione opposta, anche in caso di spazio limitato", "Superamento di ostacoli (vetture parcheggiate, ostacoli in genere)", "Comportamento alle fermate di bus/tram", "Rispetto degli attraversamenti pedonali e dei comportamenti correlati ai pedoni", "Guida proattiva - Capacit√† di prevenire il pericolo", "Capacit√† di adattamento velocit√† alla strada ed ai suoi limiti", "Corretto utilizzo del cambio di velocit√† (eco)", "Comprensione del punto di cambiata", "Utilizzo razionale dell'inerzia (eco roll)", "Utilizzo razionale del freno motore (cut-off)", "Rispetto delle distanze di sicurezza", "Ingresso su corsia di accelerazione", "Inserimento nel traffico in condizioni di sicurezza", "Capacit√† di valutazione delle distanze ed adattamento al traffico", "Uso corretto degli specchi retrovisori nella fase di inizio del sorpasso", "Corretta gestione del volante nella fase di inizio e fine sorpasso", "Rientro dal sorpasso in sicurezza (specchi, ecc)", "Uscita su strade a precedenza mediante corsia di decelerazione", "Retromarcia in rettilineo", "Retromarcia ad L con svolta a sinistra", "Retromarcia ad L con svolta a destra", "Inversione di marcia con marcia avanti", "Inversione di marcia in retromarcia", "Parcheggi in retromarcia parallelo a destra", "Parcheggi in retromarcia parallelo a sinistra", "Parcheggio in retromarcia su strada in pendenza", "Parcheggio a pettine (in retromarcia ed in avanti)", "Parcheggio a spina (in retromarcia ed in avanti)", "Controllo carta di circolazione", "Controllo pneumatici", "Controllo sterzo e comandi sul volante", "Controllo livelli", "Controllo dispositivi di segnalazione visiva ed illuminazione", "Controllo corretta chiusura porte - cofano motore", "Corrette operazioni nella discesa dal veicolo"];

    const SCORE_5_INTERPRETATION = { 0: { text: "Non trattato / Grave", color: "bg-score-0" }, 1: { text: "Grave / Intervento", color: "bg-score-1" }, 2: { text: "Migliorabile / Imprecisa", color: "bg-score-2" }, 3: { text: "Sufficiente / Adeguato", color: "bg-score-3" }, 4: { text: "Buono / Fluida", color: "bg-score-4" }, 5: { text: "Ottimo / Controllo totale", color: "bg-score-5" } };

    const COMPETENCY_AREAS = [ { name: "1. Postura, Sguardo, Volante", criteria: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13] }, { name: "2. Acceleratore e Freno", criteria: [14, 15, 16, 17, 18] }, { name: "3. Frizione e Cambio", criteria: [19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34] }, { name: "4. Incroci e Svolte", criteria: [35, 36, 37, 38, 39, 40] }, { name: "5. Guida Notturna Urbana - Mod. A", criteria: [41, 42, 43, 44, 45, 46] }, { name: "6. Guida Extraurbana ed EcoGuida - Mod. B", criteria: [47, 48, 49, 50, 51, 52] }, { name: "7. Guida in Autostrada - Mod. C", criteria: [53, 54, 55, 56, 57, 58, 59] }, { name: "8. Retromarcia ed Inversione", criteria: [60, 61, 62, 63, 64] }, { name: "9. Parcheggi", criteria: [65, 66, 67, 68, 69] }, { name: "10. Fase I Esame", criteria: [70, 71, 72, 73, 74, 75, 76] } ];
    
    const EXAM_CRITERIA = { 'a': "Azione sul volante", 'b': "Azione sul cambio", 'c': "Uso sulla frizione", 'd': "Spunto in salita", 'e': "Manovre parcheggio", 'f': "Azionamento altri comandi", 'g': "Svolta a destra e sinistra", 'h': "Attraversamento incroci", 'i': "Mano da tenere", 'l': "Rispetto segnaletica orizzontale", 'm': "Rispetto segnaletica", 'n': "Transito in rotatorie", 'o': "Transito in sensi unici", 'p': "Strade pluricorsie", 'q': "Conversione ad U", 'r': "Sorpasso", 's': "Rispetto delle precedenze", 't': "Distanze di sicurezza", 'u': "Velocit√† adeguata", 'v': "Corretta positura nell'osservazione", 'z': "Tempestivit√† nell'osservazione", 'x': "Valutazione del pericolo" };

    // --- FUNZIONI UTILITY PER I COLORI ---
    function getScoreClass(score) {
        const s = Math.round(score);
        if (s === 0) return 'bg-score-0';
        if (s === 1) return 'bg-score-1';
        if (s === 2) return 'bg-score-2';
        if (s === 3) return 'bg-score-3';
        if (s === 4) return 'bg-score-4';
        if (s === 5) return 'bg-score-5';
        return 'bg-gray-200 text-gray-800'; 
    }

    // --- LOGICA DI RICERCA GLOBALE ---
    function getAllStudentsFlat() {
        const list = [];
        for (const [loc, licences] of Object.entries(DB_ALLIEVI)) {
            for (const [lic, names] of Object.entries(licences)) {
                names.forEach(name => {
                    list.push({ name, loc, lic, label: `${name} (${loc} - ${lic})` });
                });
            }
        }
        return list;
    }

    function handleGlobalSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        if (!query || query.length < 2) {
            resultsContainer.classList.add('hidden');
            return;
        }

        const allStudents = getAllStudentsFlat();
        const lowerQuery = query.toLowerCase();
        
        const filtered = allStudents.filter(s => s.name.toLowerCase().includes(lowerQuery));
        
        let html = '';
        if (filtered.length > 0) {
            html = filtered.map(s => `
                <div class="suggestion-item" onclick="selectGlobalStudent('${s.loc}', '${s.lic}', '${s.name.replace(/'/g, "\\'")}')">
                    <span class="font-bold text-gray-800">${s.name}</span>
                    <span class="text-xs text-gray-500 ml-2">${s.loc} - ${s.lic}</span>
                </div>
            `).join('');
        }
        
        html += `
            <div class="suggestion-item border-t border-gray-200 bg-gray-50" onclick="selectNewStudent('${query.replace(/'/g, "\\'")}')">
                <span class="font-bold text-blue-600">+ Usa "${query}" come nuovo allievo</span>
                <span class="text-xs text-gray-500 block">Inserirai Sede e Patente manualmente</span>
            </div>
        `;

        resultsContainer.innerHTML = html;
        resultsContainer.classList.remove('hidden');
    }
    window.handleGlobalSearch = handleGlobalSearch;

    function selectGlobalStudent(loc, lic, name) {
        const locSelect = document.getElementById('location-select');
        locSelect.value = loc;
        updateLicenseOptions(); 
        
        const licSelect = document.getElementById('license-type-select');
        licSelect.value = lic;
        toggleLicenseInput(); 
        updateStudentOptions(); 

        const studSelect = document.getElementById('student-select');
        studSelect.value = name;
        checkManualStudentInput(); 

        document.getElementById('global-student-search').value = '';
        document.getElementById('search-results').classList.add('hidden');
        
        document.getElementById('duration-input').focus();
    }
    window.selectGlobalStudent = selectGlobalStudent;

    function selectNewStudent(name) {
        document.getElementById('location-select').value = "";
        updateLicenseOptions();
        
        const manualNameInput = document.getElementById('student-name-manual');
        manualNameInput.value = name;
        manualNameInput.classList.remove('hidden'); 
        
        document.getElementById('global-student-search').value = '';
        document.getElementById('search-results').classList.add('hidden');
        
        document.getElementById('location-select').focus();
    }
    window.selectNewStudent = selectNewStudent;
    
    document.addEventListener('click', function(e) {
        const searchBox = document.getElementById('global-student-search');
        const results = document.getElementById('search-results');
        if (!searchBox.contains(e.target) && !results.contains(e.target)) {
            results.classList.add('hidden');
        }
    });

    // --- FUNZIONI DATABASE ---
    function initDatabaseSelects() {
        const locationSelect = document.getElementById('location-select');
        const editLocationSelect = document.getElementById('edit-location-select');
        
        locationSelect.innerHTML = '<option value="">Seleziona Sede...</option>';
        Object.keys(DB_ALLIEVI).sort().forEach(loc => {
            locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
        });
        locationSelect.innerHTML += '<option value="other">Altro (inserisci manuale)</option>';
        
        if (editLocationSelect) {
            editLocationSelect.innerHTML = '';
             Object.keys(DB_ALLIEVI).sort().forEach(loc => {
                editLocationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
            });
            editLocationSelect.innerHTML += '<option value="other">Altro...</option>';
        }
    }

    function updateLicenseOptions() {
        const locationSelect = document.getElementById('location-select');
        const licenseSelect = document.getElementById('license-type-select');
        const studentSelect = document.getElementById('student-select');
        const location = locationSelect.value;
        const manualLocInput = document.getElementById('location-input-manual');
        const manualLicenseInput = document.getElementById('license-input-manual');

        licenseSelect.innerHTML = '<option value="">Seleziona Patente...</option>';
        licenseSelect.disabled = true;
        studentSelect.innerHTML = '<option value="">Prima seleziona Patente</option>';
        studentSelect.disabled = true;
        manualLicenseInput.classList.add('hidden');

        if (location === 'other') {
            manualLocInput.classList.remove('hidden');
            licenseSelect.innerHTML = '<option value="other_license">Altro (inserisci manualmente)</option>';
            licenseSelect.disabled = false;
            // FIX: Quando la sede √® "other", forziamo la chiamata per mostrare il box manuale della patente
            toggleLicenseInput(); 
            updateStudentOptions();
            return;
        } else {
            manualLocInput.classList.add('hidden');
        }

        // Se la sede esiste nel DB (anche se vuota come Paliano)
        if (location && DB_ALLIEVI[location]) {
            const licenses = Object.keys(DB_ALLIEVI[location]);
            if (licenses.length > 0) {
                licenses.forEach(lic => {
                    licenseSelect.innerHTML += `<option value="${lic}">${lic}</option>`;
                });
            }
            // SEMPRE AGGIUNGI OPZIONE MANUALE
            licenseSelect.innerHTML += '<option value="other_license">Altro (inserisci manualmente)</option>';
            licenseSelect.disabled = false;
        }
    }
    window.updateLicenseOptions = updateLicenseOptions;
    
    function toggleLicenseInput(shouldFocus = false) {
        const locationSelect = document.getElementById('location-select');
        const licenseSelect = document.getElementById('license-type-select');
        const manualLicenseInput = document.getElementById('license-input-manual');
        
        // Se la sede √® "other", il box patente manuale deve apparire SEMPRE
        if(locationSelect.value === 'other') {
             licenseSelect.value = 'other_license'; // Forza selezione
             manualLicenseInput.classList.remove('hidden');
             // Non facciamo focus qui per non saltare se l'utente sta scrivendo la sede
        } else {
             // Comportamento standard
             if(licenseSelect.value === 'other_license') {
                manualLicenseInput.classList.remove('hidden');
                if(shouldFocus) manualLicenseInput.focus();
            } else {
                manualLicenseInput.classList.add('hidden');
            }
        }
    }
    window.toggleLicenseInput = toggleLicenseInput;

    function updateStudentOptions() {
        const location = document.getElementById('location-select').value;
        const license = document.getElementById('license-type-select').value;
        const studentSelect = document.getElementById('student-select');
        const manualStudentInput = document.getElementById('student-name-manual');

        studentSelect.innerHTML = '<option value="">Seleziona Allievo...</option>';
        studentSelect.disabled = true;
        
        // IMPORTANT: Only hide if NOT using "New Student" feature from search
        // Check if value is set and we are in init phase
        if (manualStudentInput.value === "") {
             manualStudentInput.classList.add('hidden');
        }

        // Se siamo in modalit√† manuale
        if (location === 'other' || license === 'other_license') {
             studentSelect.innerHTML = '<option value="manual">Inserimento Manuale</option>';
             studentSelect.disabled = false;
             studentSelect.value = 'manual';
             checkManualStudentInput();
             return;
        }

        if (location && license && DB_ALLIEVI[location] && DB_ALLIEVI[location][license]) {
            const students = DB_ALLIEVI[location][license];
            students.sort().forEach(stud => {
                studentSelect.innerHTML += `<option value="${stud}">${stud}</option>`;
            });
        }
        // SEMPRE AGGIUNGI OPZIONE MANUALE
        studentSelect.innerHTML += '<option value="manual">-- Nuovo / Non in lista --</option>';
        studentSelect.disabled = false;
        
        // Restore manual selection if we came from Search "New Student"
        if (manualStudentInput.value !== "") {
            studentSelect.value = 'manual';
            checkManualStudentInput();
        }
    }
    window.updateStudentOptions = updateStudentOptions;

    function checkManualStudentInput(shouldFocus = false) {
        const studentSelect = document.getElementById('student-select');
        const manualInput = document.getElementById('student-name-manual');
        if (studentSelect.value === 'manual') {
            manualInput.classList.remove('hidden');
            if(shouldFocus) manualInput.focus();
        } else {
            manualInput.classList.add('hidden');
        }
    }
    window.checkManualStudentInput = checkManualStudentInput;
    
    // --- UPDATE STUDENT NAME (NO TRIM DURING TYPING) ---
    function updateStudentName(newName) {
        if (!currentLessonId) return;
        const currentDataString = localStorage.getItem(currentLessonId);
        if (!currentDataString) return;
        
        const lessonData = JSON.parse(currentDataString);
        lessonData.studentName = newName; 
        localStorage.setItem(currentLessonId, JSON.stringify(lessonData));
    }
    window.updateStudentName = updateStudentName;

    // --- CALCOLI E LOGICA CORE ---
    function customRound(value) {
        if (value <= 0.5) return 0;
        if (value <= 1.5) return 1;
        if (value <= 2.5) return 2;
        if (value <= 3.5) return 3;
        if (value <= 4.5) return 4;
        return 5; 
    }

    function calculateAreaScore(indices, detailedScores) {
        let sum = 0; let count = 0;
        indices.forEach(index => {
            const criterionName = DETAILED_CRITERIA[index];
            const score = detailedScores[criterionName];
            if (typeof score === 'number') { sum += score; count++; }
        });
        const average_0_5_raw = count > 0 ? sum / count : 0;
        const score_0_50 = Math.min(50, Math.max(0, parseFloat((average_0_5_raw * 10).toFixed(0))));
        
        const average_0_5_display = Math.round(average_0_5_raw); 

        return { score_0_50, average_0_5_display };
    }

    function calculateScores(quickScores, cardType = 'B') {
        const calculatedScores = {};
        const competencyAreas_0_50 = {}; 
        const competencyAreas_0_5 = {}; 
        let totalScore_0_500 = 0;
        
        if (cardType !== 'B') {
             DETAILED_CRITERIA.forEach(c => calculatedScores[c] = 0);
             COMPETENCY_AREAS.forEach(a => { competencyAreas_0_50[a.name] = 0; competencyAreas_0_5[a.name] = 0; });
             return { calculatedScores: calculatedScores, competencyAreas_0_50: competencyAreas_0_50, competencyAreas_0_5: competencyAreas_0_5, totalScore_0_500: 0 };
        }

        const q = QUICK_CRITERIA.map(name => quickScores[name] || 0);
        const getQ = (index) => { const val = q[index]; return (typeof val === 'number') ? val : 0; }; 
        const formulas = [
            (q) => (getQ(17) * 1) / 2, (q) => (getQ(18) * 0.5 + getQ(17) * 0.5) / 2, (q) => (getQ(17) * 1) / 2, (q) => (getQ(1) * 0.5 + getQ(8) * 0.25 + getQ(9) * 0.25) / 2, (q) => (getQ(1) * 0.4 + getQ(8) * 0.3 + getQ(9) * 0.3) / 2, (q) => (getQ(1) * 0.5 + getQ(8) * 0.25 + getQ(9) * 0.25) / 2, (q) => (getQ(1) * 0.6 + getQ(8) * 0.2 + getQ(9) * 0.2) / 2, (q) => (getQ(0) * 1) / 2, (q) => (getQ(0) * 1) / 2, (q) => (getQ(0) * 1) / 2, (q) => (getQ(0) * 1) / 2, (q) => (getQ(0) * 0.5 + getQ(8) * 0.5) / 2, (q) => (getQ(0) * 0.5 + getQ(9) * 0.5) / 2, (q) => (getQ(18) * 0.4 + getQ(10) * 0.1 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(15) * 0.1) / 2, (q) => (getQ(2) > 0 ? (getQ(2) * 0.5 + getQ(0) * 0.5) : 0) / 2, (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.5) : 0) / 2, (q) => (getQ(2) > 0 ? (getQ(17) * 1) : 0) / 2, (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.25 + getQ(15) * 0.25) : 0) / 2, (q) => (getQ(3) > 0 ? (getQ(3) * 0.5 + getQ(0) * 0.25 + getQ(16) * 0.25) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 1) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(17) * 0.5) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(2) * 0.5) : 0) / 2, (q) => (getQ(5) > 0 ? (getQ(5) * 0.5 + getQ(2) * 0.5) : 0) / 2, (q) => (getQ(6) * 1) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(17) * 0.5) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.7 + getQ(5) * 0.3) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.7 + getQ(5) * 0.2 + getQ(3) * 0.1) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(5) * 0.25 + getQ(7) * 0.25) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(5) * 0.2 + getQ(3) * 0.2 + getQ(7) * 0.1) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(17) * 0.5) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(1) * 0.5) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.5 + getQ(3) * 0.25 + getQ(5) * 0.25) : 0) / 2, (q) => (getQ(4) > 0 ? (getQ(4) * 0.25 + getQ(3) * 0.25 + getQ(5) * 0.25 + getQ(1) * 0.25) : 0) / 2, (q) => (getQ(9) * 1) / 2, (q) => (getQ(9) * 1) / 2, (q) => (getQ(8) * 1) / 2, (q) => (getQ(10) * 1) / 2, (q) => (getQ(10) * 0.8 + getQ(0) * 0.1 + getQ(16) * 0.1) / 2, (q) => (getQ(10) * 0.8 + getQ(0) * 0.1 + getQ(16) * 0.1) / 2, (q) => (getQ(0) * 0.75 + getQ(16) * 0.25) / 2, (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, (q) => (getQ(10) * 0.5 + getQ(0) * 0.3 + getQ(7) * 0.1 + getQ(19) * 0.1) / 2, (q) => (getQ(0) * 0.5 + getQ(16) * 0.5) / 2, (q) => (getQ(2) * 0.5 + getQ(3) * 0.5) / 2, (q) => (getQ(4) * 0.5 + getQ(7) * 0.5) / 2, (q) => (getQ(4) * 1) / 2, (q) => (getQ(4) * 0.5 + getQ(5) * 0.5) / 2, (q) => (getQ(3) * 0.2 + getQ(4) * 0.8) / 2, (q) => (getQ(0) * 0.5 + getQ(7) * 0.5) / 2, (q) => (getQ(10) * 1) / 2, (q) => (getQ(7) * 0.2 + getQ(1) * 0.2 + getQ(2) * 0.2 + getQ(5) * 0.2 + getQ(11) * 0.2) / 2, (q) => (getQ(0) * 0.5 + getQ(7) * 0.5) / 2, (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, (q) => (getQ(1) * 1) / 2, (q) => (getQ(18) * 0.5 + getQ(19) * 0.5) / 2, (q) => (getQ(10) * 1) / 2, (q) => (getQ(12) > 0 ? (getQ(12) * 1) : 0) / 2, (q) => (getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(9) * 0.2) : 0) / 2, (q) => (getQ(12) > 0 ? (getQ(12) * 0.8 + getQ(8) * 0.2) : 0) / 2, (q) => (getQ(13) * 1) / 2, (q) => (getQ(13) * 1) / 2, (q) => (getQ(14) * 1) / 2, (q) => (getQ(14) * 1) / 2, (q) => (getQ(14) * 1) / 2, (q) => (getQ(14) * 1) / 2, (q) => (getQ(14) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2, (q) => (getQ(19) * 1) / 2
        ];
        
        DETAILED_CRITERIA.forEach((criterion, index) => {
            try { calculatedScores[criterion] = customRound(formulas[index](q)); } catch (e) { calculatedScores[criterion] = 0; }
        });
        
        COMPETENCY_AREAS.forEach(area => {
            const { score_0_50, average_0_5_display } = calculateAreaScore(area.criteria, calculatedScores);
            competencyAreas_0_50[area.name] = score_0_50; 
            competencyAreas_0_5[area.name] = average_0_5_display;
            totalScore_0_500 += score_0_50;
        });

        return { calculatedScores, competencyAreas_0_50, competencyAreas_0_5, totalScore_0_500 };
    }

    function calculateExamPredictionFromDetailed(detailedScores) {
        const predictions = {}; const threshold = 3; const isSI = (val) => val >= threshold ? "SI" : "NO";
        const avgDetailed = (indices) => {
            let sum = 0; let count = 0;
            indices.forEach(index => { const score = detailedScores[DETAILED_CRITERIA[index]]; if (typeof score === 'number') { sum += score; count++; } });
            return count > 0 ? (sum / count) : 0;
        };
        predictions.a = isSI(avgDetailed([3, 4, 5, 6])); predictions.b = isSI(avgDetailed([27, 28, 29, 30, 31])); predictions.c = isSI(avgDetailed([19, 20, 21, 22, 23, 24])); predictions.d = isSI(detailedScores[DETAILED_CRITERIA[25]]); predictions.e = isSI(avgDetailed([65, 66, 67, 68, 69])); predictions.f = isSI(avgDetailed([72, 74])); predictions.g = isSI(avgDetailed([35, 36, 37])); predictions.h = isSI(avgDetailed([39, 40])); predictions.i = isSI(avgDetailed([42, 43, 44, 45])); predictions.l = isSI(detailedScores[DETAILED_CRITERIA[40]]); predictions.m = isSI(detailedScores[DETAILED_CRITERIA[40]]); predictions.n = isSI(detailedScores[DETAILED_CRITERIA[38]]); predictions.o = isSI(detailedScores[DETAILED_CRITERIA[36]]); predictions.p = isSI(avgDetailed([53, 54, 55, 59])); predictions.q = isSI(avgDetailed([63, 64])); predictions.r = isSI(avgDetailed([56, 57, 58])); predictions.s = isSI(detailedScores[DETAILED_CRITERIA[40]]); predictions.t = isSI(detailedScores[DETAILED_CRITERIA[52]]); predictions.u = isSI(detailedScores[DETAILED_CRITERIA[47]]); predictions.v = isSI(avgDetailed([7, 8, 9, 10, 11, 12])); predictions.z = isSI(detailedScores[DETAILED_CRITERIA[13]]); predictions.x = isSI(detailedScores[DETAILED_CRITERIA[46]]);
        return predictions;
    }

    // --- INIT ---
    function initPage() {
        initDatabaseSelects();
        const defaultQuickScores = {};
        QUICK_CRITERIA.forEach(name => { if (name.includes("(Tempo)")) defaultQuickScores[name] = ""; else defaultQuickScores[name] = 5; });
        const defaultDetailedScores = calculateScores(defaultQuickScores).calculatedScores;
        const defaultPredictions = calculateExamPredictionFromDetailed(defaultDetailedScores);
        renderExamPredictions(defaultPredictions);
        showHomeView();
    }
    
    // --- NAVIGAZIONE ---
    function showHomeView() {
        document.getElementById('home-view').classList.remove('hidden');
        document.getElementById('calculator-page').classList.add('hidden');
        
        // Reset campi e Selects
        document.getElementById('location-select').value = "";
        document.getElementById('license-type-select').innerHTML = '<option value="">Prima seleziona Sede</option>';
        document.getElementById('license-type-select').disabled = true;
        document.getElementById('license-input-manual').value = "";
        document.getElementById('license-input-manual').classList.add('hidden');
        
        document.getElementById('student-select').innerHTML = '<option value="">Prima seleziona Patente</option>';
        document.getElementById('student-select').disabled = true;
        document.getElementById('student-name-manual').value = "";
        document.getElementById('student-name-manual').classList.add('hidden');
        
        document.getElementById('lesson-date-input').value = new Date().toISOString().split('T')[0];
        loadSavedLessonsList();
        
        document.getElementById('export-btn').onclick = exportData;
        document.getElementById('import-btn').onclick = () => document.getElementById('import-file-input').click();
    }

    function showCalculatorPage(lessonId) {
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('calculator-page').classList.remove('hidden');
        document.querySelectorAll('#calculator-page details').forEach(el => el.open = false);
        document.querySelectorAll('.scratch-cover').forEach(el => { el.classList.remove('hidden'); el.style.opacity = '1'; });
        loadLesson(lessonId);
    }
    window.goBackToList = showHomeView;

    // --- FUNZIONALITA' ---
    function toggleLocationInput() {
        const select = document.getElementById('location-select');
        const manualInput = document.getElementById('location-input-manual');
        if (select.value === 'other') manualInput.classList.remove('hidden'); else manualInput.classList.add('hidden');
    }
    window.toggleLocationInput = toggleLocationInput;

    function startNewLesson() {
        const locationSelect = document.getElementById('location-select');
        const licenseSelect = document.getElementById('license-type-select');
        const manualLicenseInput = document.getElementById('license-input-manual');
        const studentSelect = document.getElementById('student-select');
        const manualLocInput = document.getElementById('location-input-manual');
        const manualStudentInput = document.getElementById('student-name-manual');
        
        let location = locationSelect.value;
        if(location === 'other') location = manualLocInput.value.trim() || "Sede non specificata";
        
        let licenseType = licenseSelect.value;
        if(licenseSelect.value === 'other_license') licenseType = manualLicenseInput.value.trim() || "Patente non specificata";

        let studentName = "";
        if(studentSelect.value === 'manual' || location === 'other' || licenseSelect.value === 'other_license' || studentSelect.disabled) {
            studentName = manualStudentInput.value.trim();
        } else {
            studentName = studentSelect.value;
        }
        
        const durationInput = document.getElementById('duration-input');
        const dateInput = document.getElementById('lesson-date-input');
        let createdAt = dateInput.value ? new Date(dateInput.value).toISOString() : new Date().toISOString();
        
        const errorEl = document.getElementById('landing-error');
        if (!studentName || studentName.length < 3) { errorEl.textContent = "Seleziona un allievo o inserisci un nome valido (min 3 caratteri)."; errorEl.classList.remove('hidden'); return; }
        if (!location) { errorEl.textContent = "Seleziona una sede."; errorEl.classList.remove('hidden'); return; }
        errorEl.classList.add('hidden');

        // Reset editing flag
        isEditingExistingLesson = false;
        
        const lessonId = `lesson_${new Date().getTime()}`;
        const defaultQuickScores = {};
        
        // Initial setup based on B
        const initialCard = 'B';
        const allowedIndices = CARD_CONFIGS[initialCard];

        QUICK_CRITERIA.forEach((name, index) => {
            if (allowedIndices.includes(index)) {
                if (name.includes("(Tempo)")) {
                     defaultQuickScores[name] = "";
                 } else {
                     defaultQuickScores[name] = 5;
                 }
            } else {
                defaultQuickScores[name] = ""; // Empty for hidden
            }
        });

        const lessonData = { id: lessonId, studentName: studentName, licenseType: licenseType || "B", duration: durationInput.value, location: location, createdAt: createdAt, notes: "", moduloSvolto: "nessuno", quickScores: defaultQuickScores, selectedCard: 'B', isLocked: false, isArchived: false, finalScore: null, cloudSynced: false }; 
        localStorage.setItem(lessonId, JSON.stringify(lessonData));
        showCalculatorPage(lessonId);
    }
    window.startNewLesson = startNewLesson;
    
    // --- SINGLE LESSON SYNC ---
    function uploadSingleLesson(id) {
        if(!navigator.onLine) { alert("Nessuna connessione internet."); return; }
        if(!confirm("Vuoi provare a inviare nuovamente questa lezione al cloud?")) return;
        
        const lesson = JSON.parse(localStorage.getItem(id));
        
        // Prepare single lesson export object
        const obj = { 
            appName: "RegistroValutazioniGuida", 
            exportDate: new Date().toISOString(), 
            lessons: [lesson], // Single lesson array
            folderId: "16aVHvVSoy2J48gQKp_VCiBdRrQNf9CHl"
        };
        
        // Use fetch to send
        fetch(GOOGLE_SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(obj) 
        }).then(() => {
             // Mark as synced on apparent success
             lesson.cloudSynced = true;
             localStorage.setItem(id, JSON.stringify(lesson));
             loadSavedLessonsList(); // Refresh list to update icon
             alert("Lezione inviata! (Nota: Verifica sempre il Drive se possibile)");
        }).catch(err => {
             console.error("Errore invio singolo", err);
             alert("Errore di rete durante l'invio.");
        });
    }
    window.uploadSingleLesson = uploadSingleLesson;

    function loadSavedLessonsList() {
        const activeList = document.getElementById('saved-lessons-list');
        const archivedList = document.getElementById('archived-lessons-list');
        activeList.innerHTML = ''; archivedList.innerHTML = '';
        const lessons = [];
        for (let i = 0; i < localStorage.length; i++) { if (localStorage.key(i).startsWith('lesson_')) try { lessons.push(JSON.parse(localStorage.getItem(localStorage.key(i)))); } catch (e) {} }
        
        if (lessons.length === 0) { activeList.innerHTML = '<p class="text-gray-500">Nessuna valutazione salvata.</p>'; return; }
        const renderGroup = (list, container, isArchived) => {
            if (list.length === 0) { container.innerHTML = '<p class="text-gray-400 italic text-sm">Nessuna valutazione qui.</p>'; return; }
            list.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            list.forEach(data => {
                const key = data.id;
                const status = data.isLocked ? '<span class="text-green-700 font-bold text-xs border border-green-200 bg-green-50 rounded px-1">Salvata</span>' : '<span class="text-yellow-600 font-bold text-xs border border-yellow-200 bg-yellow-50 rounded px-1">Aperta</span>';
                let scoreDisplay = ''; if (data.isLocked && data.finalScore != null && data.selectedCard === 'B') scoreDisplay = `<span class="text-sm text-indigo-700 font-bold ml-2">(${data.finalScore}/500)</span>`;
                let actionLink = data.isLocked ? `<a href="#" class="ml-2 text-xs font-bold text-blue-600 hover:text-blue-800 underline" onclick="unlockAndOpenLesson('${key}'); return false;">‚úèÔ∏è Modifica</a>` : '';
                
                // Cloud Sync Status Logic - Only for Archived items
                let syncStatus = '';
                if (isArchived) {
                    const isSynced = data.cloudSynced === true;
                    if (isSynced) {
                        syncStatus = '<span class="ml-2 text-green-500 text-xs" title="Sincronizzato">‚òÅÔ∏è OK</span>';
                    } else {
                        syncStatus = `
                            <span class="ml-2 text-red-500 text-xs font-bold" title="Non sincronizzato">‚ö†Ô∏è Cloud</span>
                            <button onclick="uploadSingleLesson('${key}')" class="ml-1 text-[10px] bg-red-100 text-red-600 border border-red-200 px-1 rounded hover:bg-red-200">Riprova</button>
                        `;
                    }
                }
                
                const details = `Pat. ${data.licenseType || 'B'} ‚Ä¢ ${data.duration || 60} min ‚Ä¢ ${data.location || 'Sede ?'}`;
                const item = document.createElement('div'); item.className = 'saved-lesson-item';
                item.innerHTML = `<div class="flex-grow min-w-0"><div class="flex items-center flex-wrap"><a href="#" class="font-bold text-lg text-blue-700 hover:underline truncate mr-2" onclick="openLesson('${key}'); return false;">${data.studentName}</a>${status}${actionLink}${scoreDisplay}${syncStatus}</div><div class="text-xs text-gray-500 mt-1"><span class="font-medium text-gray-700">${details}</span> | ${new Date(data.createdAt).toLocaleDateString()}</div></div><button class="delete-btn ml-2" onclick="deleteLesson('${key}')">&times;</button>`;
                container.appendChild(item);
            });
        };
        renderGroup(lessons.filter(l => !l.isArchived), activeList, false); // False for active list
        renderGroup(lessons.filter(l => l.isArchived), archivedList, true);   // True for archived list
    }

    function deleteLesson(id) { if(confirm("Eliminare?")) { localStorage.removeItem(id); loadSavedLessonsList(); } }
    window.deleteLesson = deleteLesson;
    function deleteAllData() { if(confirm("Cancellare TUTTO?")) { localStorage.clear(); loadSavedLessonsList(); } }
    window.deleteAllData = deleteAllData;

    function openLesson(id) { showCalculatorPage(id); }
    window.openLesson = openLesson;
    
    function unlockAndOpenLesson(id) {
        if(confirm("Vuoi riaprire questa valutazione salvata per modificarla?")) {
            const data = JSON.parse(localStorage.getItem(id));
            data.isLocked = false;
            // Mark as unsynced so we know it changed (and move to pending export)
            data.cloudSynced = false;
            // If it was archived, bring it back to active list to force re-export
            data.isArchived = false;
            localStorage.setItem(id, JSON.stringify(data));
            
            // Set flag for editing
            isEditingExistingLesson = true;
            
            showCalculatorPage(id);
        }
    }
    window.unlockAndOpenLesson = unlockAndOpenLesson;

    function loadLesson(id) {
        currentLessonId = id;
        const data = JSON.parse(localStorage.getItem(id));
        quickScores = data.quickScores || {};
        currentCardFilter = data.selectedCard || 'B';
        
        document.getElementById('student-name-edit').value = data.studentName;
        document.getElementById('lesson-notes').value = data.notes || "";
        document.getElementById('edit-license-type').value = data.licenseType || "B";
        document.getElementById('edit-duration').value = data.duration || "60";
        
        // Populate Date in Header
        const dateInput = document.getElementById('edit-lesson-date');
        if (data.createdAt) {
            // Extract YYYY-MM-DD from ISO string
            dateInput.value = data.createdAt.split('T')[0];
        }
        
        const locSelect = document.getElementById('edit-location-select');
        const manualLoc = document.getElementById('edit-location-manual');
        const closeBtn = document.getElementById('close-manual-loc');
        let found = false;
        for(let i=0; i<locSelect.options.length; i++) if(locSelect.options[i].value === data.location) { locSelect.selectedIndex = i; found = true; break; }
        if(!found) { locSelect.value = "other"; manualLoc.value = data.location; manualLoc.classList.remove('hidden'); closeBtn.classList.remove('hidden'); }
        else { manualLoc.classList.add('hidden'); closeBtn.classList.add('hidden'); }

        const modRadio = document.querySelector(`input[name="modulo_obbligatorio"][value="${data.moduloSvolto || 'nessuno'}"]`);
        if(modRadio) modRadio.checked = true;

        updateCardFilter(currentCardFilter, false); 
        if(data.isLocked) lockPage(); else unlockPage();
        
        document.querySelectorAll('input[name="card-filter"]').forEach(rb => rb.checked = (rb.value === currentCardFilter));
    }

    function saveLessonData(locking = false) {
        if(!currentLessonId) return;
        const data = JSON.parse(localStorage.getItem(currentLessonId));
        if(data.isLocked && !locking) return;
        
        data.notes = document.getElementById('lesson-notes').value;
        data.quickScores = quickScores;
        data.selectedCard = currentCardFilter;
        
        // SAFE ACCESS TO RADIO BUTTON
        const checkedRadio = document.querySelector('input[name="modulo_obbligatorio"]:checked');
        data.moduloSvolto = checkedRadio ? checkedRadio.value : "nessuno";
        
        // Note: we don't save header details here, they are saved via their own onchange events (updateLessonDetails)
        
        localStorage.setItem(currentLessonId, JSON.stringify(data));
    }
    window.saveLessonData = saveLessonData;

    function saveAndLockLesson() {
        if(!currentLessonId) return;
        if(confirm("Sei sicuro di voler salvare e archiviare questa valutazione?")) {
            saveLessonData(true); 
            try {
                const data = JSON.parse(localStorage.getItem(currentLessonId));
                let finalScore = 0;
                try {
                    const result = calculateScores(data.quickScores, currentCardFilter);
                    finalScore = result.totalScore_0_500;
                } catch(err) {
                    console.warn("Calcolo punteggio non riuscito, impostato a 0.", err);
                    finalScore = 0;
                }
                
                data.finalScore = finalScore;
                data.isLocked = true;
                // Don't set cloudSynced true here, only after export!
                localStorage.setItem(currentLessonId, JSON.stringify(data));
                
                const toast = document.getElementById('toast-notification');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
                
                showHomeView(); 
            } catch(e) {
                alert("Errore durante il salvataggio: " + e.message);
            }
        }
    }
    window.saveAndLockLesson = saveAndLockLesson;
    
    function unlockLesson() {
        if(confirm("Riaprire modifica?")) {
            const data = JSON.parse(localStorage.getItem(currentLessonId));
            data.isLocked = false;
            // Mark as unsynced so we know it changed
            data.cloudSynced = false;
            // If it was archived, bring back to active
            data.isArchived = false;
            localStorage.setItem(currentLessonId, JSON.stringify(data));
            
            isEditingExistingLesson = true;
            
            unlockPage();
            
            // Hide master slider when modifying existing
            const masterContainer = document.getElementById('master-slider-container');
            if(masterContainer) masterContainer.classList.add('hidden');
        }
    }
    window.unlockLesson = unlockLesson;

    function lockPage() {
        document.getElementById('lock-status').innerHTML = 'Stato: <span class="text-green-700 font-bold">Salvata</span>';
        document.getElementById('lock-lesson-btn').classList.add('hidden');
        document.getElementById('unlock-lesson-btn').classList.remove('hidden');
        document.getElementById('lesson-notes').disabled = true;
        document.getElementById('student-name-edit').disabled = true;
        document.getElementById('edit-lesson-date').disabled = true;
        document.getElementById('edit-license-type').disabled = true;
        document.getElementById('edit-duration').disabled = true;
        document.getElementById('edit-location-select').disabled = true;
        document.getElementById('edit-location-manual').disabled = true;
        document.getElementById('close-manual-loc').classList.add('hidden');
        document.getElementById('master-slider').disabled = true;
        document.querySelectorAll('.score-slider').forEach(s => s.disabled = true);
        document.querySelectorAll('input[type="text"][data-time]').forEach(i => i.disabled = true);
        document.querySelectorAll('input[name="modulo_obbligatorio"]').forEach(r => r.disabled = true);
        document.querySelectorAll('.radio-filter').forEach(r => r.disabled = true);
        document.querySelectorAll('select.score-select').forEach(s => s.disabled = true); 
    }

    function unlockPage() {
        document.getElementById('lock-status').innerHTML = 'Stato: <span class="text-green-600">In corso...</span>';
        document.getElementById('lock-lesson-btn').classList.remove('hidden');
        document.getElementById('unlock-lesson-btn').classList.add('hidden');
        document.getElementById('lesson-notes').disabled = false;
        document.getElementById('student-name-edit').disabled = false;
        document.getElementById('edit-lesson-date').disabled = false;
        document.getElementById('edit-license-type').disabled = false;
        document.getElementById('edit-duration').disabled = false;
        document.getElementById('edit-location-select').disabled = false;
        document.getElementById('edit-location-manual').disabled = false;
        if(document.getElementById('edit-location-select').value === 'other') document.getElementById('close-manual-loc').classList.remove('hidden');
        document.getElementById('master-slider').disabled = false;
        document.querySelectorAll('.score-slider').forEach(s => s.disabled = false);
        document.querySelectorAll('input[type="text"][data-time]').forEach(i => i.disabled = false);
        document.querySelectorAll('input[name="modulo_obbligatorio"]').forEach(r => r.disabled = false);
        document.querySelectorAll('.radio-filter').forEach(r => r.disabled = false);
        document.querySelectorAll('select.score-select').forEach(s => s.disabled = false); 
    }
    
    // UPDATE LESSON DETAILS (Header Edit)
    function updateLessonDetails() {
        if(!currentLessonId) return;
        const data = JSON.parse(localStorage.getItem(currentLessonId));
        
        data.licenseType = document.getElementById('edit-license-type').value.toUpperCase();
        data.duration = document.getElementById('edit-duration').value;
        const locSelect = document.getElementById('edit-location-select');
        data.location = (locSelect.value === 'other') ? document.getElementById('edit-location-manual').value : locSelect.value;
        
        // Date update logic
        const newDateVal = document.getElementById('edit-lesson-date').value;
        if (newDateVal) {
            // Keep the time from original createdAt if possible, or just default T00:00:00
            // Here we just construct a new ISO string from the date input.
            // Note: input type date returns YYYY-MM-DD. 
            // We'll append current time to keep it sortable somewhat correctly or just use T12:00:00
            // Better: parse original, set year/month/date
            try {
                const originalDate = new Date(data.createdAt);
                const [y, m, d] = newDateVal.split('-').map(Number);
                originalDate.setFullYear(y);
                originalDate.setMonth(m - 1);
                originalDate.setDate(d);
                data.createdAt = originalDate.toISOString();
            } catch(e) {
                data.createdAt = new Date(newDateVal).toISOString();
            }
        }

        localStorage.setItem(currentLessonId, JSON.stringify(data));
    }
    window.updateLessonDetails = updateLessonDetails;
    
    function toggleEditLocationInput() {
        const sel = document.getElementById('edit-location-select');
        const inp = document.getElementById('edit-location-manual');
        const btn = document.getElementById('close-manual-loc');
        if(sel.value === 'other') { inp.classList.remove('hidden'); btn.classList.remove('hidden'); inp.focus(); }
        else { inp.classList.add('hidden'); btn.classList.add('hidden'); }
    }
    window.toggleEditLocationInput = toggleEditLocationInput;
    
    function resetEditLocation() {
        document.getElementById('edit-location-select').value = "Colleferro";
        toggleEditLocationInput();
        updateLessonDetails();
    }
    window.resetEditLocation = resetEditLocation;

    // --- FUNZIONE TOGGLE EMOJI MODE ---
    function toggleEmojiMode() {
        showEmojis = !showEmojis;
        document.getElementById('toggle-icon-display').textContent = showEmojis ? "üî¢" : "üôÇ";
        
        // Aggiorna Master Slider
        const masterVal = parseInt(document.getElementById('master-slider').value);
        document.getElementById('master-value-display').textContent = showEmojis ? EMOJI_INTERPRETATION[masterVal] : masterVal;

        // Aggiorna tutti gli slider renderizzati
        const container = document.getElementById('quick-criteria-container');
        const valueSpans = container.querySelectorAll('span[id^="val-"]');
        valueSpans.forEach(span => {
            const idx = span.id.split('-')[1]; 
            const slider = document.getElementById(`slider-${idx}`);
            if(slider) {
                const val = parseInt(slider.value);
                span.textContent = showEmojis ? EMOJI_INTERPRETATION[val] : val;
                // Opzionale: Aggiungi classe per rendere il numero pi√π grande/grassetto se necessario
                if(!showEmojis) {
                    span.classList.add('font-bold', 'text-gray-800');
                } else {
                    span.classList.remove('font-bold', 'text-gray-800');
                }
            }
        });
    }
    window.toggleEmojiMode = toggleEmojiMode;

    function updateCardFilter(filter, save = true) {
        currentCardFilter = filter;
        if(save) {
            const allowed = CARD_CONFIGS[filter];
            QUICK_CRITERIA.forEach((c, i) => {
                if(allowed.includes(i)) { 
                    if(c.includes("(Tempo)")) quickScores[c] = "";
                    else if (filter === 'Superiori') quickScores[c] = ""; // Reset for dropdowns
                    else quickScores[c] = 5; 
                } else { 
                    quickScores[c] = ""; 
                }
            });
            saveLessonData(false);
        }
        
        // Toggle Master Slider & Emoji Button Visibility for Superiori AND Edit Mode
        const isSuperiori = (filter === 'Superiori');
        const masterContainer = document.getElementById('master-slider-container');
        const emojiBtn = document.getElementById('emoji-toggle-btn');
        
        if(masterContainer) {
            if(isSuperiori || isEditingExistingLesson) masterContainer.classList.add('hidden');
            else masterContainer.classList.remove('hidden');
        }
        
        if(emojiBtn) {
            if(isSuperiori) emojiBtn.classList.add('hidden');
            else emojiBtn.classList.remove('hidden');
        }

        renderQuickCriteria();
        const scores = calculateScores(quickScores, filter);
        // Toggle sections based on 'B'
        const hide = filter !== 'B';
        ['total-score-section','competency-section-wrapper','detailed-summary-section-wrapper','exam-prediction-section', 'mandatory-modules-section'].forEach(id => {
            const el = document.getElementById(id); if(el) if(hide) el.classList.add('hidden'); else el.classList.remove('hidden');
        });

        if(!hide) {
            renderDetailedSummary(scores.calculatedScores);
            renderCompetencyAreas(scores.competencyAreas_0_50, scores.competencyAreas_0_5, scores.totalScore_0_500);
            renderExamPredictions(calculateExamPredictionFromDetailed(scores.calculatedScores));
        }
    }
    window.updateCardFilter = updateCardFilter;

    function renderQuickCriteria() {
        const container = document.getElementById('quick-criteria-container');
        const indices = CARD_CONFIGS[currentCardFilter] || CARD_CONFIGS['B'];
        container.innerHTML = indices.map((idx, displayIdx) => {
            const c = QUICK_CRITERIA[idx];
            const val = quickScores[c];
            
            // Caso SUPERIORI: Dropdown
            if (currentCardFilter === 'Superiori') {
                return `
                <div class="space-y-1 p-3 bg-purple-50 rounded-lg shadow-inner border border-purple-100">
                    <label class="block text-sm font-semibold text-purple-900">${displayIdx+1}. ${c}</label>
                    <select class="score-select w-full p-2 border border-purple-300 rounded focus:ring-purple-500 focus:border-purple-500" 
                            data-name="${c}" onchange="updateDropdownScore(event)">
                        <option value="" ${!val ? 'selected' : ''}>Seleziona...</option>
                        <option value="S√¨" ${val === 'S√¨' ? 'selected' : ''}>S√¨</option>
                        <option value="No" ${val === 'No' ? 'selected' : ''}>No</option>
                        <option value="Da rivedere" ${val === 'Da rivedere' ? 'selected' : ''}>Da rivedere</option>
                        <option value="Pericolo" ${val === 'Pericolo' ? 'selected' : ''}>Pericolo</option>
                    </select>
                </div>`;
            }

            // Caso TEMPO
            if(c.includes("(Tempo)")) {
                 return `<div class="space-y-1 p-3 bg-blue-50 rounded-lg shadow-inner border border-blue-100"><label class="block text-sm font-semibold text-blue-800">${displayIdx+1}. ${c}</label><div class="flex items-center space-x-3"><input type="text" value="${val||''}" data-name="${c}" placeholder="00:00" class="w-full p-2 text-lg font-mono border border-blue-300 rounded text-center" oninput="updateQuickTime(event)"></div></div>`;
            } 
            
            // Caso STANDARD (Slider)
            else {
                 const v = (val!=null && val!=="") ? val : 5;
                 const displayVal = showEmojis ? EMOJI_INTERPRETATION[v] : v; 
                 return `<div class="space-y-1 p-3 bg-gray-50 rounded-lg shadow-inner"><label class="block text-sm font-semibold text-gray-700">${displayIdx+1}. ${c}</label><p id="desc-${idx}" class="text-xs h-8 text-gray-500 overflow-hidden hidden">${SCORE_10_INTERPRETATION[v]}</p><div class="flex items-center space-x-3"><span id="val-${idx}" class="text-4xl w-12 text-center cursor-default ${!showEmojis ? 'font-bold text-gray-800' : ''}" onmousedown="showTooltip(event, ${idx})" onmouseup="hideTooltip()" ontouchstart="showTooltip(event, ${idx})" ontouchend="hideTooltip()">${displayVal}</span><input type="range" min="0" max="10" value="${v}" id="slider-${idx}" data-idx="${idx}" data-name="${c}" class="score-slider flex-grow" oninput="updateQuickScore(event)"></div></div>`;
            }
        }).join('');
    }

    // Funzione specifica per i Dropdown (Superiori)
    function updateDropdownScore(e) {
        const name = e.target.getAttribute('data-name');
        const val = e.target.value;
        quickScores[name] = val;
        saveLessonData(false);
    }
    window.updateDropdownScore = updateDropdownScore;

    function updateQuickScore(e) {
        const idx = e.target.getAttribute('data-idx');
        const name = e.target.getAttribute('data-name');
        const val = parseInt(e.target.value);
        
        const displayVal = showEmojis ? EMOJI_INTERPRETATION[val] : val;
        document.getElementById(`val-${idx}`).textContent = displayVal;
        
        document.getElementById(`desc-${idx}`).textContent = SCORE_10_INTERPRETATION[val];
        quickScores[name] = val;
        if(currentCardFilter === 'B') {
            const s = calculateScores(quickScores, 'B');
            renderDetailedSummary(s.calculatedScores);
            renderCompetencyAreas(s.competencyAreas_0_50, s.competencyAreas_0_5, s.totalScore_0_500);
            renderExamPredictions(calculateExamPredictionFromDetailed(s.calculatedScores));
        }
    }
    window.updateQuickScore = updateQuickScore;

    function updateQuickTime(e) { quickScores[e.target.getAttribute('data-name')] = e.target.value; saveLessonData(false); }
    window.updateQuickTime = updateQuickTime;

    function updateMasterScore(e) {
        const val = parseInt(e.target.value);
        const displayVal = showEmojis ? EMOJI_INTERPRETATION[val] : val;
        document.getElementById('master-value-display').textContent = displayVal;
        
        const indices = CARD_CONFIGS[currentCardFilter];
        indices.forEach(idx => {
            const name = QUICK_CRITERIA[idx];
            // Skip Tempo and Superiori dropdown logic
            if(!name.includes("(Tempo)") && currentCardFilter !== 'Superiori') {
                quickScores[name] = val;
                const sl = document.getElementById(`slider-${idx}`);
                if(sl) {
                    sl.value = val;
                    document.getElementById(`val-${idx}`).textContent = displayVal;
                    document.getElementById(`desc-${idx}`).textContent = SCORE_10_INTERPRETATION[val];
                }
            }
        });
        saveLessonData(false);
        if(currentCardFilter === 'B') {
             const s = calculateScores(quickScores, 'B');
             renderDetailedSummary(s.calculatedScores);
             renderCompetencyAreas(s.competencyAreas_0_50, s.competencyAreas_0_5, s.totalScore_0_500);
             renderExamPredictions(calculateExamPredictionFromDetailed(s.calculatedScores));
        }
    }
    window.updateMasterScore = updateMasterScore;

    function renderDetailedSummary(scores) {
        let h = '';
        COMPETENCY_AREAS.forEach(a => {
            h += `<div class="mt-4 mb-3 col-span-full border-b pb-1"><h3 class="text-base font-semibold text-gray-800">${a.name}</h3></div><div class="grid md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 col-span-full">`;
            a.criteria.forEach(i => {
                const sc = scores[DETAILED_CRITERIA[i]] || 0;
                // APPLICA COLORE PERSONALIZZATO
                const colorClass = getScoreClass(sc);
                h += `<div class="grid grid-cols-[1fr_auto] items-center gap-2 text-sm"><span class="text-gray-700 truncate" title="${DETAILED_CRITERIA[i]}">${DETAILED_CRITERIA[i]}</span><span class="flex items-center justify-center w-6 h-6 font-bold rounded-full text-xs ${colorClass}">${sc}</span></div>`;
            });
            h += `</div>`;
        });
        document.getElementById('calculated-scores-container').innerHTML = h;
    }

    function renderCompetencyAreas(sc50, sc5, total) {
        document.getElementById('competency-summary').innerHTML = COMPETENCY_AREAS.map(a => {
            const s = sc5[a.name] || 0;
            // APPLICA COLORE PERSONALIZZATO (s √® gi√† arrotondato)
            const colorClass = getScoreClass(s);
            return `<div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 bg-white shadow-sm"><span class="font-medium text-gray-700">${a.name}</span><span class="flex items-center justify-center w-8 h-8 text-sm font-bold rounded-full ${colorClass}">${s}</span></div>`;
        }).join('');
        document.getElementById('total-score-500').textContent = `${total} / 500`;
    }

    function renderExamPredictions(preds) {
        let h = '';
        for(const [k, t] of Object.entries(EXAM_CRITERIA)) {
            const res = preds[k] || "NO";
            h += `<div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 bg-white shadow-sm"><span class="font-medium text-gray-700">${k}) ${t}</span><div class="scratch-container"><div id="result-${k}" class="scratch-result ${res==='SI'?'si':'no'}">${res}</div><div id="cover-${k}" class="scratch-cover" onclick="reveal('${k}')">GRATTA QUI</div></div></div>`;
        }
        document.getElementById('exam-items-container').innerHTML = h;
    }
    
    function reveal(k) { const el = document.getElementById(`cover-${k}`); if(el) { el.style.opacity = '0'; setTimeout(()=>el.classList.add('hidden'), 300); } }
    window.reveal = reveal;

    function showTooltip(e, idx) {
        e.preventDefault();
        const sl = document.getElementById(`slider-${idx}`);
        if(!sl) return;
        tooltip.textContent = SCORE_10_INTERPRETATION[sl.value];
        tooltip.classList.remove('hidden');
        const t = e.touches ? e.touches[0] : e;
        tooltip.style.left = (t.pageX + 15) + 'px'; tooltip.style.top = (t.pageY + 15) + 'px';
    }
    window.showTooltip = showTooltip;
    window.hideTooltip = () => tooltip.classList.add('hidden');

    function exportData() {
        const status = document.getElementById('import-status');
        const obj = { 
            appName: "RegistroValutazioniGuida", 
            exportDate: new Date().toISOString(), 
            lessons: [],
            folderId: "16aVHvVSoy2J48gQKp_VCiBdRrQNf9CHl" // ID CARTELLA DRIVE TARGET
        };
        
        const toArchive = [];
        for(let i=0; i<localStorage.length; i++) {
            if(localStorage.key(i).startsWith('lesson_')) {
                const l = JSON.parse(localStorage.getItem(localStorage.key(i)));
                if(!l.isArchived) { 
                    // Ensure calculation is consistent
                    l.finalScore = calculateScores(l.quickScores||{}, l.selectedCard||'B').totalScore_0_500;
                    if(!l.location) l.location="Sede non specificata";
                    obj.lessons.push(l); toArchive.push(l);
                }
            }
        }

        if(obj.lessons.length === 0) { status.textContent = "Nessuna nuova valutazione da esportare."; status.className = "text-sm mt-3 text-yellow-600"; return; }

        if(!navigator.onLine) {
            if(!confirm("‚ö†Ô∏è SEI OFFLINE.\nVuoi scaricare il backup locale? Le lezioni NON verranno archiviate.")) { status.textContent = "Export annullato."; return; }
            downloadJSON(obj, `backup_offline_${new Date().toISOString().split('T')[0]}.json`);
            status.textContent = "Backup scaricato SOLO in locale. Riprova online per archiviare.";
            status.className = "text-sm mt-3 text-orange-600 font-bold";
            return;
        }

        // Online flow
        downloadJSON(obj, `export_registro_${new Date().toISOString().split('T')[0]}.json`);
        
        // ARCHIVIAZIONE
        setTimeout(() => {
            toArchive.forEach(l => { l.isArchived = true; localStorage.setItem(l.id, JSON.stringify(l)); });
            loadSavedLessonsList();
            status.textContent = `Esportate ${obj.lessons.length} lezioni.`;
            status.className = "text-sm mt-3 text-green-600 font-bold";
        }, 1000);
        
        // Send to Cloud (POST Request)
        // Note: Using fetch with no-cors is standard for simple fire-and-forget to GAS web apps
        fetch(GOOGLE_SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(obj) 
        }).then(() => {
             console.log("Dati inviati al cloud");
        }).catch(err => {
             console.error("Errore invio cloud", err);
             alert("Attenzione: Impossibile contattare il server cloud. Il file locale √® comunque salvo.");
        });
    }
    window.exportData = exportData;

    function downloadJSON(obj, name) {
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type : 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name;
        document.body.appendChild(a); a.click();
        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
    }

    function importData(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const d = JSON.parse(ev.target.result);
                if(d.appName === "RegistroValutazioniGuida" && Array.isArray(d.lessons)) {
                    if(confirm(`Importare ${d.lessons.length} lezioni?`)) {
                        d.lessons.forEach(l => localStorage.setItem(l.id, JSON.stringify(l)));
                        loadSavedLessonsList();
                        document.getElementById('import-status').textContent = "Importazione completata.";
                    }
                }
            } catch(err) { console.error(err); alert("File non valido"); }
            e.target.value = null;
        };
        reader.readAsText(file);
    }
    window.importData = importData;

    initPage();
</script>
</body>
</html>
